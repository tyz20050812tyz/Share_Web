# 项目运行部署指南

## 📋 目录
- [1. 基于脚本的快速部署](#1-基于脚本的快速部署)
- [2. 手动部署方法](#2-手动部署方法)
- [3. 常见问题及解决方案](#3-常见问题及解决方案)
- [4. 部署验证方法](#4-部署验证方法)

---

## 1. 基于脚本的快速部署

### 1.1 脚本说明
项目提供了两个核心脚本用于快速启动和停止服务：
- **`run_website.bat`** - 一键启动脚本
- **`stop_website.bat`** - 停止服务脚本

### 1.2 使用步骤

#### 启动服务
1. **定位脚本文件**
   - 进入项目根目录（下载或解压后的项目文件夹）
   - 找到 `run_website.bat` 文件

2. **执行启动脚本**
   ```batch
   # 双击运行或命令行执行
   run_website.bat
   ```

3. **脚本执行流程**
   - **步骤1**：检查 Node.js 是否已安装
   - **步骤2**：自动进入 `server` 目录
   - **步骤3**：执行 `npm install` 安装依赖
   - **步骤4**：在新窗口启动服务器（默认端口 3000）
   - **步骤5**：等待 3 秒后自动打开浏览器

4. **预期输出**
   ```
   [INFO] Initializing...
   [INFO] Installing dependencies (npm install)...
   [INFO] Starting server on PORT 3000...
   [INFO] Opening browser: http://localhost:3000/index.html
   [DONE] If browser didn't open, manually visit: http://localhost:3000/index.html
   ```

#### 停止服务
1. **执行停止脚本**
   ```batch
   # 双击运行或命令行执行
   stop_website.bat
   ```

2. **脚本执行流程**
   - **步骤1**：查找所有运行中的 Node.js 进程
   - **步骤2**：强制终止所有 Node.js 进程
   - **步骤3**：检查端口 3000/3001/3002 占用情况

3. **预期输出**
   ```
   [1/2] 正在查找运行中的Node.js进程...
   ✓ 成功停止所有Node.js进程
   [2/2] 检查端口占用情况...
   ✓ 端口 3000, 3001, 3002 已全部释放
   ```

### 1.3 脚本参数配置

#### `run_website.bat` 可配置参数
打开脚本文件，在顶部找到以下配置项：

| 参数名 | 默认值 | 说明 |
|--------|--------|------|
| `PORT` | 3000 | 服务器监听端口 |
| `ROOT_DIR` | 当前目录 | 项目根目录 |
| `SERVER_DIR` | `%ROOT_DIR%server` | 服务器代码目录 |

**修改端口示例**：
```batch
# 打开 run_website.bat 文件，找到以下行：
set PORT=3000

# 修改为其他端口（如 8080）：
set PORT=8080
```

### 1.4 所需权限
- **普通用户权限**：通常情况下无需管理员权限
- **管理员权限**：仅在以下情况需要：
  - 首次安装依赖时遇到权限问题
  - 停止脚本无法终止进程时

---

## 2. 手动部署方法

### 2.1 环境准备

#### 操作系统要求
- **支持系统**：Windows 7/10/11，Windows Server 2012+
- **推荐系统**：Windows 10 或更高版本
- **用户权限**：普通用户权限即可，无需管理员权限

#### 系统要求
- **内存**：至少 2GB 可用内存
- **磁盘空间**：至少 500MB 可用空间（用于依赖包）
- **网络**：需要互联网连接（用于安装依赖和调用 AI API）

### 2.2 依赖安装

#### 安装 Node.js
1. **下载 Node.js**
   - 访问官网：https://nodejs.org/
   - 推荐版本：LTS 版本（16.x 或更高）
   - 下载 Windows 安装包（.msi 文件）

2. **安装步骤**
   ```
   1. 双击安装包
   2. 点击"Next"（下一步）
   3. 接受协议
   4. 选择安装路径（建议默认）
   5. 勾选"Add to PATH"（添加到环境变量）
   6. 点击"Install"（安装）
   ```

3. **验证安装**
   ```bash
   # 打开命令提示符（CMD）或 PowerShell
   node --version   # 应显示版本号，如 v18.17.0
   npm --version    # 应显示版本号，如 9.6.7
   ```

#### 安装项目依赖
```bash
# 1. 进入项目根目录（替换为你的实际路径）
cd "你的项目路径"

# 2. 进入服务器目录
cd server

# 3. 安装依赖包
npm install
```

**预期安装的依赖包**：
- `express` (^4.18.2) - Web 服务器框架
- `node-fetch` (^2.6.7) - HTTP 请求库
- `open` (^10.2.0) - 自动打开浏览器工具

### 2.3 配置文件设置

#### 核心配置文件
位置：`server/config.local.json`

```json
{
  "DEEPSEEK_API_URL": "https://api.deepseek.com/v1/chat/completions",
  "DEEPSEEK_API_KEY": "您的API密钥",
  "DEEPSEEK_API_KEY_HEADER": "Authorization",
  "DEEPSEEK_MODEL": "deepseek-chat",
  "ENABLE_MOCK": true
}
```

#### 配置参数说明

| 参数名 | 类型 | 说明 | 推荐值 |
|--------|------|------|--------|
| `DEEPSEEK_API_URL` | String | DeepSeek API 地址 | `https://api.deepseek.com/v1/chat/completions` |
| `DEEPSEEK_API_KEY` | String | API 密钥（必须替换） | 申请获取的真实密钥 |
| `DEEPSEEK_API_KEY_HEADER` | String | 认证头名称 | `Authorization` |
| `DEEPSEEK_MODEL` | String | 使用的模型 | `deepseek-chat` |
| `ENABLE_MOCK` | Boolean | 是否启用模拟模式 | `false`（生产环境）<br>`true`（测试环境） |

#### 环境变量配置（可选）
也可以通过环境变量替代配置文件：

```bash
# PowerShell 设置环境变量
$env:PORT = "3000"
$env:DEEPSEEK_API_KEY = "您的API密钥"
$env:ENABLE_MOCK = "false"
```

#### 数据文件初始化
项目使用 JSON 文件存储数据，以下文件会在首次运行时自动创建：

| 文件名 | 路径 | 说明 |
|--------|------|------|
| `users.json` | `server/` | 用户账号数据 |
| `forum.json` | `server/` | 论坛讨论数据 |
| `guestbook.json` | `server/` | 留言板数据 |
| `submissions.json` | `server/` | 创作投稿数据 |
| `contests.json` | `server/` | 竞赛数据 |
| `quiz_rankings.json` | `server/` | 游戏排行榜数据 |
| `history_events.json` | `server/` | 历史事件数据 |

**注意**：这些文件不需要手动创建，服务器会自动初始化。

### 2.4 服务启动

#### 方法一：使用 npm 启动
```bash
# 1. 进入服务器目录（替换为你的实际路径）
cd "你的项目路径\server"

# 2. 启动服务
npm start
```

#### 方法二：使用 Node.js 直接启动
```bash
# 1. 进入服务器目录（替换为你的实际路径）
cd "你的项目路径\server"

# 2. 直接运行
node index.js
```

#### 方法三：指定端口启动
```bash
# PowerShell
$env:PORT = "8080"
npm start

# CMD
set PORT=8080 && npm start
```

#### 成功启动的标志
看到以下输出表示服务器启动成功：
```
Server is running on http://localhost:3000
```

#### 访问网站
启动成功后，在浏览器中访问：
```
http://localhost:3000/
```
系统会自动重定向到登录页面。

---

## 3. 常见问题及解决方案

### 问题 1：Node.js 未找到

**症状表现**：
```
[ERROR] Node.js not found. Opening download page...
```
或命令行提示：
```
'node' 不是内部或外部命令，也不是可运行的程序或批处理文件。
```

**原因分析**：
- Node.js 未安装
- Node.js 已安装但未添加到系统环境变量

**解决步骤**：
1. **检查是否已安装**
   ```bash
   node --version
   ```
2. **如果未安装**
   - 访问 https://nodejs.org/ 下载并安装
   - 安装时确保勾选 "Add to PATH" 选项

3. **如果已安装但命令不可用**
   - 重启命令行窗口
   - 或手动添加到 PATH：
     ```
     控制面板 → 系统 → 高级系统设置 → 环境变量
     在 Path 中添加 Node.js 安装路径（如 C:\Program Files\nodejs）
     ```

---

### 问题 2：端口被占用

**症状表现**：
```
Error: listen EADDRINUSE: address already in use :::3000
```

**原因分析**：
- 端口 3000 已被其他程序占用
- 上次运行的服务未正确关闭

**解决步骤**：

**方法一：使用停止脚本**
```batch
stop_website.bat
```

**方法二：手动查找并终止进程**
```bash
# 1. 查找占用端口的进程
netstat -ano | findstr :3000

# 2. 记下 PID（最后一列数字）
# 3. 终止进程（替换 <PID> 为实际进程号）
taskkill /F /PID <PID>
```

**方法三：更换端口**
```bash
# 修改 PORT 环境变量
$env:PORT = "3001"
npm start
```

---

### 问题 3：npm install 失败

**症状表现**：
```
[ERROR] npm install failed.
npm ERR! code ENOTFOUND
npm ERR! network request to https://registry.npmjs.org/... failed
```

**原因分析**：
- 网络连接问题
- npm 源访问慢或被屏蔽
- 防火墙或代理设置问题

**解决步骤**：

**方法一：切换国内镜像源**
```bash
# 临时使用淘宝镜像
npm install --registry=https://registry.npmmirror.com

# 永久设置（推荐）
npm config set registry https://registry.npmmirror.com
```

**方法二：清除缓存重试**
```bash
npm cache clean --force
npm install
```

**方法三：删除 node_modules 重新安装**
```bash
# 在 server 目录下执行
Remove-Item -Recurse -Force node_modules
Remove-Item -Force package-lock.json
npm install
```

---

### 问题 4：浏览器无法访问页面

**症状表现**：
- 浏览器显示 "无法访问此网站"
- 页面一直加载中
- 404 Not Found

**原因分析**：
- 服务器未启动成功
- 访问地址错误
- 防火墙阻止访问

**解决步骤**：

**检查服务器状态**
```bash
# 1. 查看服务器进程是否运行
tasklist | findstr node.exe

# 2. 检查端口监听状态
netstat -ano | findstr :3000
```

**检查访问地址**
- 确保访问：`http://localhost:3000/`（注意 http 协议）
- 不要访问：`https://localhost:3000/`（没有 s）

**检查防火墙**
```
控制面板 → Windows Defender 防火墙 → 允许应用通过防火墙
确保 Node.js 已被允许
```

**查看服务器日志**
- 回到启动服务器的命令行窗口
- 查看是否有错误信息输出

---

### 问题 5：API 调用失败

**症状表现**：
- AI 对话功能无响应
- 控制台显示 API 错误
- 返回 Mock 数据而非真实回答

**原因分析**：
- API 密钥未配置或错误
- API 配额已用尽
- 网络无法访问 API 服务

**解决步骤**：

**检查配置文件**
```bash
# 1. 打开配置文件（在项目的 server 目录下）
notepad config.local.json

# 2. 确认以下配置正确
{
  "DEEPSEEK_API_KEY": "sk-xxxxxxxx",  // 检查密钥是否正确
  "ENABLE_MOCK": false                 // 生产环境应设为 false
}
```

**验证 API 密钥**
- 访问 API 提供商控制台
- 检查密钥是否有效
- 查看配额使用情况

**测试配置是否生效**
```bash
# 访问配置状态接口
curl http://localhost:3000/api/config/status
```

返回示例：
```json
{
  "deepseekUrl": "https://api.deepseek.com/v1/chat/completions",
  "model": "deepseek-chat",
  "keyHeader": "Authorization",
  "keyProvided": true,    // 应为 true
  "mockEnabled": false    // 生产环境应为 false
}
```

---

### 问题 6：文件权限错误

**症状表现**：
```
Error: EACCES: permission denied
```

**原因分析**：
- 文件被其他程序占用
- 用户权限不足
- 文件为只读状态

**解决步骤**：

**检查文件属性**
```
1. 右键点击项目目录
2. 属性 → 取消勾选"只读"
3. 点击"应用"
```

**以管理员身份运行**
```
1. 右键点击 run_website.bat
2. 选择"以管理员身份运行"
```

**关闭占用文件的程序**
- 关闭可能占用文件的编辑器、IDE
- 使用进程资源管理器查找占用文件的进程

---

### 问题 7：数据丢失或无法保存

**症状表现**：
- 用户注册后无法登录
- 发帖后刷新页面数据消失
- 服务器重启后数据丢失

**原因分析**：
- JSON 数据文件损坏
- 文件写入权限不足
- 数据文件路径错误

**解决步骤**：

**检查数据文件完整性**
```bash
# 查看数据文件（在 server 目录下执行）
cd server
dir *.json
```

**验证 JSON 格式**
```bash
# 使用记事本打开
notepad users.json

# 检查是否为有效 JSON 格式
# 应该看到类似：
[
  {
    "account": "用户名",
    "password": "密码",
    "role": "user"
  }
]
```

**修复损坏文件**
```bash
# 在 server 目录下执行，创建空数据文件
echo [] > users.json
echo [] > forum.json
echo [] > submissions.json
```

**重启服务器**
```bash
# 停止服务
stop_website.bat

# 重新启动
run_website.bat
```

---

## 4. 部署验证方法

### 4.1 验证方式一：浏览器访问测试

#### 访问主页
1. **打开浏览器**
   - 推荐使用 Chrome、Edge 或 Firefox

2. **访问地址**
   ```
   http://localhost:3000/
   ```

3. **验证成功标准**
   - ✅ 页面自动重定向到登录页 (`/login.html`)
   - ✅ 页面正常显示，无白屏或错误提示
   - ✅ CSS 样式正常加载，页面美观

4. **验证失败排查**
   - ❌ 显示"无法访问" → 检查服务器是否启动
   - ❌ 页面空白 → 按 F12 打开控制台查看错误
   - ❌ 样式错乱 → 检查静态资源路径是否正确

#### 测试核心功能
1. **用户注册**
   ```
   访问：http://localhost:3000/register.html
   操作：注册新账号
   预期：成功注册并自动跳转到登录页
   ```

2. **用户登录**
   ```
   访问：http://localhost:3000/login.html
   操作：使用刚注册的账号登录
   预期：登录成功，跳转到主页
   ```

3. **AI 对话**
   ```
   访问：http://localhost:3000/ai.html
   操作：发送一条消息
   预期：收到 AI 回复（或 Mock 回复）
   ```

### 4.2 验证方式二：API 接口测试

#### 使用浏览器测试
直接在浏览器地址栏访问以下接口：

1. **配置状态检查**
   ```
   http://localhost:3000/api/config/status
   ```
   预期返回：
   ```json
   {
     "deepseekUrl": "https://api.deepseek.com/v1/chat/completions",
     "model": "deepseek-chat",
     "keyHeader": "Authorization",
     "keyProvided": true,
     "mockEnabled": false
   }
   ```

2. **用户列表（仅开发环境）**
   ```
   http://localhost:3000/api/debug/users
   ```
   预期返回：
   ```json
   {
     "ok": true,
     "users": [...]
   }
   ```

#### 使用命令行测试
```bash
# PowerShell 测试 POST 接口
Invoke-WebRequest -Uri "http://localhost:3000/api/check-account" `
  -Method POST `
  -ContentType "application/json" `
  -Body '{"account":"testuser"}'
```

#### 使用 Postman 或 Apifox 测试
1. 创建新请求
2. 设置 URL：`http://localhost:3000/api/login`
3. 方法：POST
4. Body (JSON)：
   ```json
   {
     "account": "testuser",
     "password": "123456"
   }
   ```
5. 发送请求，验证返回结果

### 4.3 验证方式三：日志检查

#### 查看服务器控制台
启动服务器的命令行窗口应显示：

**正常启动日志**：
```
Server is running on http://localhost:3000
```

**请求日志示例**：
```
GET / 302 - - 1.234 ms
GET /login.html 200 - - 5.678 ms
POST /api/login 200 - - 12.345 ms
```

#### 检查错误日志
如果有错误，会显示堆栈信息：
```
Error: Cannot find module 'express'
    at Function.Module._resolveFilename (...)
```

**常见错误日志**：
- `EADDRINUSE` → 端口被占用
- `ENOENT` → 文件不存在
- `EACCES` → 权限不足
- `MODULE_NOT_FOUND` → 模块未安装

#### 数据文件检查
```bash
# 查看数据文件修改时间
cd server
dir *.json

# 查看用户数据
type users.json
```

验证成功标准：
- ✅ 文件修改时间随操作更新
- ✅ JSON 格式正确
- ✅ 新数据已保存

### 4.4 验证方式四：端口监听检查

#### 使用 netstat 命令
```bash
# 检查 3000 端口是否被监听
netstat -ano | findstr :3000
```

**预期输出**：
```
TCP    0.0.0.0:3000           0.0.0.0:0              LISTENING       12345
TCP    [::]:3000              [::]:0                 LISTENING       12345
```

**解读**：
- `0.0.0.0:3000` → 服务器正在监听所有网络接口的 3000 端口
- `LISTENING` → 状态为监听中
- `12345` → 进程 ID (PID)

#### 使用任务管理器
```
1. 按 Ctrl+Shift+Esc 打开任务管理器
2. 切换到"详细信息"标签
3. 查找 node.exe 进程
4. 检查 PID 是否与 netstat 输出一致
```

### 4.5 验证方式五：功能完整性测试清单

#### 基础功能
- [ ] 用户注册功能正常
- [ ] 用户登录功能正常
- [ ] 密码重置功能正常
- [ ] 用户退出功能正常

#### 核心功能
- [ ] AI 对话功能可用
- [ ] 历史知识库访问正常
- [ ] 3D 展馆模型加载成功
- [ ] 趣味射击游戏运行正常
- [ ] 创作竞赛投稿功能正常

#### 数据持久化
- [ ] 用户数据可正常保存
- [ ] 论坛帖子可正常发布和展示
- [ ] 留言板功能正常
- [ ] 排行榜数据正确更新

#### 性能测试
- [ ] 页面加载时间 < 3 秒
- [ ] AI 响应时间 < 10 秒
- [ ] 无明显的内存泄漏
- [ ] 多用户同时访问正常

---

## 📌 附录

### A. 快速命令参考

```bash
# 启动服务
cd server
npm start

# 停止服务（Windows）
taskkill /F /IM node.exe

# 查看端口占用
netstat -ano | findstr :3000

# 安装依赖
npm install

# 清除缓存
npm cache clean --force

# 切换镜像源
npm config set registry https://registry.npmmirror.com

# 检查 Node.js 版本
node --version
npm --version
```

### B. 默认账号信息

系统默认管理员账号：
- 账号：`佟雨泽`
- 密码：`20050812`
- 角色：`admin`

**注意**：建议首次部署后立即修改默认密码！

### C. 技术支持

遇到问题无法解决？
1. 查看 `server/README.md` 了解更多技术细节
2. 检查浏览器控制台（F12）的错误信息
3. 查看服务器命令行窗口的日志输出
4. 联系技术负责人获取支持

---

**文档版本**：v1.0  
**最后更新**：2025-11-04  
**适用项目版本**：1.0.0
