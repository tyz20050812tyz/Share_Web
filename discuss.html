<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸»é¢˜è®¨è®ºåŒº â€” æŠ—æ—¥ç²¾ç¥ä¸æ°‘æ—å¤å…´</title>
    <link rel="stylesheet" href="./style.css">
</head>

<body>
    <header class="site-header">
        <div class="wrap">
            <h1>ä¸»é¢˜è®¨è®ºåŒº</h1>
            <nav class="main-nav">
                <a href="../index.html">ä¸»é¡µ</a>
                <a href="ai.html">æ™ºèƒ½é—®ç­”</a>
                <a href="knowledge.html">çŸ¥è¯†åˆ†äº«</a>
                <a href="culture.html">æ–‡åŒ–ä¼ æ’­</a>
                <a href="discuss.html">è®¨è®ºåŒº</a>
                <a href="game.html">è¶£å‘³å°„å‡»</a>
                <a href="models.html">3Då±•é¦†</a>
            </nav>
        </div>
    </header>

    <main class="wrap">
        <section class="card">
            <div class="section-title">å‘å¸ƒä½ çš„è§‚ç‚¹</div>
            <div class="grid-3" style="grid-template-columns: 1fr;">
                <div class="post-card">
                    <label>æ˜µç§°ï¼š<input id="author" type="text" placeholder="ä¾‹å¦‚ï¼šæŠ—æˆ˜ç²¾ç¥è§‚å¯Ÿè€…" style="width:100%"></label>
                    <label style="margin-top:8px; display:block;">å†…å®¹ï¼š<textarea id="content" rows="4" placeholder="å›´ç»•æŠ—æ—¥ç²¾ç¥ã€æ°‘æ—å›¢ç»“ã€å®¶å›½æ‹…å½“ã€æ–‡åŒ–ä¼ æ‰¿ã€å¤å…´ä¹‹è·¯ç­‰å‘è¡¨è§è§£ä¸ç»éªŒ" style="width:100%"></textarea></label>
                    <div class="md-toolbar" id="md-toolbar" style="margin-top:6px; display:flex; flex-wrap:wrap; gap:6px;">
                        <span class="muted" style="font-size:12px;">Markdown å¿«æ·ï¼š</span>
                        <button type="button" class="btn btn-secondary md-btn" data-act="bold" title="åŠ ç²—">B</button>
                        <button type="button" class="btn btn-secondary md-btn" data-act="italic" title="æ–œä½“"><i>i</i></button>
                        <button type="button" class="btn btn-secondary md-btn" data-act="code" title="è¡Œå†…ä»£ç ">{ }</button>
                        <button type="button" class="btn btn-secondary md-btn" data-act="quote" title="å¼•ç”¨">&gt;</button>
                        <button type="button" class="btn btn-secondary md-btn" data-act="link" title="é“¾æ¥">ğŸ”—</button>
                        <button type="button" class="btn btn-secondary md-btn" data-act="h1" title="æ ‡é¢˜1">H1</button>
                        <button type="button" class="btn btn-secondary md-btn" data-act="h2" title="æ ‡é¢˜2">H2</button>
                        <button type="button" class="btn btn-secondary md-btn" data-act="ul" title="æ— åºåˆ—è¡¨">â€¢ åˆ—è¡¨</button>
                        <button type="button" class="btn btn-secondary" id="md-toggle" title="é¢„è§ˆåˆ‡æ¢">é¢„è§ˆ</button>
                    </div>
                    <div id="md-preview" class="markdown-body" style="display:none; border:1px dashed var(--border); border-radius:8px; padding:10px; margin-top:6px;"></div>
                    <div class="tag-select" style="margin-top:8px;">
                        <span class="tag" data-tag="æŠ—æˆ˜æ„å¿—">æŠ—æˆ˜æ„å¿—</span>
                        <span class="tag" data-tag="æ°‘æ—å›¢ç»“">æ°‘æ—å›¢ç»“</span>
                        <span class="tag" data-tag="å®¶å›½æ‹…å½“">å®¶å›½æ‹…å½“</span>
                        <span class="tag" data-tag="æ–‡åŒ–ä¼ æ‰¿">æ–‡åŒ–ä¼ æ‰¿</span>
                        <span class="tag" data-tag="å¤å…´ä¹‹è·¯">å¤å…´ä¹‹è·¯</span>
                    </div>
                    <div class="media-inputs" style="margin-top:8px;">
                        <label>å›¾ç‰‡ï¼š<input id="image" type="file" accept="image/*"></label>
                        <div id="image-preview" class="image-preview" style="margin-top:6px; display:flex; gap:6px; flex-wrap:wrap;"></div>
                        <div id="image-status" class="image-status" style="margin-top:6px; font-size:12px;">
                            <div style="display:flex; justify-content:space-between; align-items:center;">
                                <span>å·²é€‰ <span id="img-count">0</span>/6 å¼ </span>
                                <span>æ€»å¤§å° <span id="img-size">0</span> / 2MB</span>
                            </div>
                            <div class="image-progress" style="margin-top:4px; height:6px; background:#eee; border-radius:999px;">
                                <div id="image-progress-bar" style="width:0%; height:100%; background: var(--accent); border-radius:999px;"></div>
                            </div>
                            <div id="img-hint" class="muted" style="margin-top:4px;">æç¤ºï¼šå•å¼ â‰¤300KBï¼Œæœ€å¤š6å¼ ï¼Œæ€»è®¡â‰¤2MB</div>
                        </div>
                        <div class="muted" style="font-size:12px; margin-top:4px;">æ”¯æŒç²˜è´´å›¾ç‰‡ï¼ˆâ‰¤300KBï¼‰ï¼Œæ”¯æŒ Markdownï¼ˆ**åŠ ç²—**ã€[é“¾æ¥](https://...)ã€å¼•ç”¨ >ï¼‰</div>
                    </div>
                    <div class="post-actions" style="margin-top:8px;">
                        <button id="publish" class="btn" style="background: var(--accent); color:#fff; border:none;">å‘å¸ƒ</button>
                        <button id="clearAll" class="btn btn-secondary">æ¸…ç©ºæ‰€æœ‰å¸–å­ï¼ˆä»…æœ¬æœºï¼‰</button>
                    </div>
                </div>
            </div>
        </section>

        <section class="card">
            <div class="section-title">è®¨è®ºå¹¿åœº</div>
            <div class="forum-toolbar" aria-label="è®¨è®ºåŒºå·¥å…·æ¡">
                <div class="toolbar-left">
                    <input id="forum-search" type="text" placeholder="æœç´¢æ˜µç§°æˆ–å†…å®¹" class="toolbar-input">
                    <div class="tag-filter" role="group" aria-label="æ ‡ç­¾ç­›é€‰">
                        <span class="tag" data-tag="">å…¨éƒ¨</span>
                        <span class="tag" data-tag="æŠ—æˆ˜æ„å¿—">æŠ—æˆ˜æ„å¿—</span>
                        <span class="tag" data-tag="æ°‘æ—å›¢ç»“">æ°‘æ—å›¢ç»“</span>
                        <span class="tag" data-tag="å®¶å›½æ‹…å½“">å®¶å›½æ‹…å½“</span>
                        <span class="tag" data-tag="æ–‡åŒ–ä¼ æ‰¿">æ–‡åŒ–ä¼ æ‰¿</span>
                        <span class="tag" data-tag="å¤å…´ä¹‹è·¯">å¤å…´ä¹‹è·¯</span>
                    </div>
                    <div class="advanced-filter" style="margin-top:6px; display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
                        <label style="font-size:12px; color:#666;"><input type="checkbox" id="only-pinned"> ä»…ç½®é¡¶</label>
                        <label style="font-size:12px; color:#666;"><input type="checkbox" id="only-images"> ä»…å«å›¾ç‰‡</label>
                        <label style="font-size:12px; color:#666;"><input type="checkbox" id="only-links"> ä»…å«é“¾æ¥</label>
                    </div>
                </div>
                <div class="toolbar-right">
                    <label class="toolbar-label" for="forum-sort">æ’åº</label>
                    <select id="forum-sort" class="toolbar-select">
                        <option value="newest">æœ€æ–°</option>
                        <option value="hot">æœ€çƒ­</option>
                    </select>
                    <input id="my-name" type="text" placeholder="æˆ‘çš„æ˜µç§°" class="toolbar-input" style="width:120px; margin-left:8px;">
                    <label class="toolbar-label" style="margin-left:6px;"><input type="checkbox" id="only-mine"> ä»…çœ‹æˆ‘çš„</label>
                    <button id="export-json" class="btn btn-secondary" style="margin-left:8px;">å¯¼å‡ºJSON</button>
                    <button id="export-zip" class="btn btn-secondary">å¯¼å‡ºè¯„è®ºå›¾ç‰‡ZIP</button>
                    <button id="profile-btn" class="btn btn-secondary">ä¸ªäººä¸»é¡µ</button>
                </div>
            </div>
            <div class="forum-grid" style="margin-top:8px; display:grid; grid-template-columns: 2fr 1fr; gap:12px; align-items:start;">
                <div class="forum-main">
                    <div id="page-guide" class="guide-container" style="margin-bottom:10px;"></div>
                    <div id="post-list"></div>
                </div>
                <aside class="forum-sidebar">
                    <div class="sidebar-card">
                        <div class="sidebar-title">çƒ­é—¨æ ‡ç­¾æ¦œ</div>
                        <div style="margin:6px 0;">
                            <select id="hot-range" class="toolbar-select" style="width:100%;">
                                <option value="today">ä»Šæ—¥</option>
                                <option value="week">æœ¬å‘¨</option>
                                <option value="all" selected>å…¨éƒ¨</option>
                            </select>
                        </div>
                        <div id="hot-tags"></div>
                    </div>
                    <div class="sidebar-card">
                        <div class="sidebar-title">ä»Šæ—¥è¯é¢˜</div>
                        <div id="today-topic"></div>
                    </div>
                    <div class="sidebar-card">
                        <div class="sidebar-title">é¡µé¢æ‘˜è¦</div>
                        <div id="summary-text" class="muted" style="font-size:13px;"></div>
                        <div class="sidebar-actions" style="display:flex; gap:8px; margin-top:8px; flex-wrap:wrap; align-items:center;">
                            <label style="font-size:12px;"><input type="checkbox" id="summary-only-filter"> ä»…ç­›é€‰ç»“æœ</label>
                            <button id="gen-summary" class="btn btn-secondary">ç”Ÿæˆæ‘˜è¦</button>
                            <button id="speak-summary" class="btn btn-secondary">æœ—è¯»æ‘˜è¦ ğŸ”Š</button>
                            <button id="insert-guide" class="btn btn-secondary" title="å°†æ‘˜è¦æ’å…¥å¸–å­åˆ—è¡¨é¡¶éƒ¨">æ’å…¥å¯¼è¯»</button>
                            <button id="clear-guide" class="btn btn-secondary">æ¸…é™¤å¯¼è¯»</button>
                        </div>
                    </div>
                </aside>
            </div>
        </section>

        <div class="scenarios-actions">
            <p class="tip">æç¤ºï¼šæ•°æ®ä¿å­˜åœ¨æµè§ˆå™¨æœ¬åœ°ï¼ˆlocalStorageï¼‰ï¼Œä»…æœ¬æœºå¯è§ã€‚å»ºè®®å‹¿ä¸Šä¼ æ•æ„Ÿä¿¡æ¯ï¼Œå¦‚éœ€æƒå¨å’¨è¯¢è¯·å‚è€ƒå®˜æ–¹æ¸ é“ã€‚</p>
            <a href="../index.html" class="btn btn-secondary">â† è¿”å›ä¸»é¡µ</a>
        </div>
    </main>

    <footer class="site-footer">
        <div class="wrap">Â© 2025 æµ·å—è‡ªç”±è´¸æ˜“æ¸¯å°å…³è¿ä½œ</div>
    </footer>

    <!-- ä¸ªäººä¸»é¡µå¼¹çª— -->
    <div id="profile-modal" class="modal" style="display:none;">
        <div class="modal-content" style="max-width:640px;">
            <button id="profile-close" class="btn btn-secondary" style="position:absolute; right:12px; top:12px;">å…³é—­</button>
            <h3 style="margin-top:0;">ä¸ªäººä¸»é¡µ</h3>
            <div id="profile-body" class="markdown-body"></div>
        </div>
    </div>

    <!-- Markdown ä¸å®‰å…¨è¿‡æ»¤ -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.5/dist/purify.min.js"></script>
    <!-- å‹ç¼©å·¥å…·ï¼ˆå¯¼å‡ºå›¾ç‰‡ä¸ºZIPï¼‰ -->
    <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
    <!-- é€šç”¨è„šæœ¬ï¼ˆç”¨æˆ·æ ä¸é€€å‡ºï¼‰ -->
    <script src="../assets/js/main.js"></script>
    <script>
        const STORE_KEY = 'forum_posts_v1';
        const PREF_SORT_KEY = 'forum_pref_sort';
        const PREF_TAG_KEY = 'forum_pref_tag';
        const PREF_SEARCH_KEY = 'forum_pref_search';
        const PREF_TAGS_MULTI_KEY = 'forum_pref_tags_multi';
        const PINNED_ONLY_KEY = 'forum_pinned_only';
        const ONLY_IMAGES_KEY = 'forum_only_images';
        const ONLY_LINKS_KEY = 'forum_only_links';
        const MY_NAME_KEY = 'forum_my_name';
        const ONLY_MINE_KEY = 'forum_only_mine';
        const HOT_TAG_RANGE_KEY = 'forum_hot_range';
        const LOGIN_USER_KEY = 'login_user';
        const LOGIN_ROLE_KEY = 'login_role';
        const MAX_IMAGE_COUNT = 6;
        const MAX_TOTAL_SIZE = 2 * 1024 * 1024; // 2MB
        let sortMode = localStorage.getItem(PREF_SORT_KEY) || 'newest';
        let activeTag = localStorage.getItem(PREF_TAG_KEY) || '';
        let keyword = localStorage.getItem(PREF_SEARCH_KEY) || '';
        let activeTags = JSON.parse(localStorage.getItem(PREF_TAGS_MULTI_KEY) || '[]');
        let pinnedOnly = localStorage.getItem(PINNED_ONLY_KEY) === 'true';
        let onlyImages = localStorage.getItem(ONLY_IMAGES_KEY) === 'true';
        let onlyLinks = localStorage.getItem(ONLY_LINKS_KEY) === 'true';
        let myName = localStorage.getItem(MY_NAME_KEY) || '';
        let onlyMine = localStorage.getItem(ONLY_MINE_KEY) === 'true';
        let hotRange = localStorage.getItem(HOT_TAG_RANGE_KEY) || 'all';
        const currentUser = localStorage.getItem(LOGIN_USER_KEY) || '';
        const currentRole = localStorage.getItem(LOGIN_ROLE_KEY) || 'user';
        const isAdmin = currentRole === 'admin';
        if (!myName && currentUser) {
            myName = currentUser;
            try {
                localStorage.setItem(MY_NAME_KEY, myName);
            } catch {}
        }
        // === åç«¯åŒæ­¥ï¼šé›†ä¸­å­˜å‚¨ï¼Œæ‰€æœ‰äººå¯è§ ===
        const API_BASE = '/api/forum';
        async function apiGet(path, headers = {}) {
            try {
                const resp = await fetch(path, {
                    headers
                });
                if (!resp.ok) throw new Error(resp.statusText);
                return await resp.json();
            } catch (e) {
                console.warn('apiGet failed:', e.message);
                return null;
            }
        }
        async function apiPost(path, data, headers = {}) {
            try {
                const resp = await fetch(path, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        ...headers
                    },
                    body: JSON.stringify(data || {})
                });
                return resp;
            } catch (e) {
                console.warn('apiPost failed:', e.message);
                return {
                    ok: false,
                    status: 0
                };
            }
        }

        function adminHeaders() {
            return {
                'x-auth-user': encodeURIComponent(currentUser || ''),
                'x-auth-role': currentRole || ''
            };
        }
        async function syncFromServer() {
            const data = await apiGet(`${API_BASE}/posts`);
            const list = data && (Array.isArray(data.posts) ? data.posts : (Array.isArray(data) ? data : [])) || [];
            savePosts(list);
            return list;
        }

        function loadPosts() {
            try {
                return JSON.parse(localStorage.getItem(STORE_KEY)) || [];
            } catch {
                return [];
            }
        }

        function savePosts(list) {
            try {
                localStorage.setItem(STORE_KEY, JSON.stringify(list));
            } catch {}
        }

        function renderPosts(list) {
            const box = document.getElementById('post-list');
            if (!box) return;
            if (!list.length) {
                box.innerHTML = '<div class="muted">ç›®å‰è¿˜æ²¡æœ‰å¸–å­ï¼Œå¿«æ¥å‘å¸ƒç¬¬ä¸€æ¡å§ï¼</div>';
                return;
            }
            const html = list.slice().reverse().map(p => {
                const time = new Date(p.ts).toLocaleString();
                const commentsHtml = (p.comments || []).map(c => {
                    const ct = new Date(c.ts).toLocaleString();
                    return `<div class="post-card" style="margin-top:6px;">
                    <div style="font-size:12px; color:#666;">${ct} Â· ${escapeHtml(c.author || 'åŒ¿å')}</div>
                    <div>${escapeHtml(c.content || '')}</div>
                </div>`;
                }).join('');
                return `<div class="post-card" data-id="${p.id}">
                <div style="font-size:12px; color:#666;">${time} Â· ${escapeHtml(p.author || 'åŒ¿å')}</div>
                <div style="margin-top:4px;">${escapeHtml(p.content || '')}</div>
                <div class="post-actions" style="margin-top:6px;">
                    <button class="btn btn-secondary like-btn">ğŸ‘ ç‚¹èµ</button>
                    <span class="like-count">${p.likes || 0} èµ</span>
                </div>
                <details style="margin-top:8px;">
                    <summary>å‘è¡¨è¯„è®º</summary>
                    <div style="margin-top:6px;">
                        <input class="c-author" type="text" placeholder="æ˜µç§°" style="width: 40%;"> 
                        <input class="c-content" type="text" placeholder="è¯„è®ºå†…å®¹" style="width: 58%;"> 
                        <button class="btn btn-secondary c-submit">å‘å¸ƒè¯„è®º</button>
                    </div>
                    <div class="comments">${commentsHtml}</div>
                </details>
            </div>`;
            }).join('');
            box.innerHTML = html;

            // ç»‘å®šäº¤äº’
            box.querySelectorAll('.like-btn').forEach(btn => {
                btn.addEventListener('click', async() => {
                    const card = btn.closest('.post-card');
                    const id = card && card.dataset && card.dataset.id;
                    const posts = loadPosts();
                    const p = posts.find(x => String(x.id) === String(id));
                    if (p) {
                        await apiPost(`${API_BASE}/like`, {
                            id
                        });
                        p.likes = (p.likes || 0) + 1;
                        savePosts(posts);
                        renderPosts(posts);
                    }
                });
            });
            box.querySelectorAll('.c-submit').forEach(btn => {
                btn.addEventListener('click', async() => {
                    const card = btn.closest('.post-card');
                    const id = card && card.dataset && card.dataset.id;
                    const author = card.querySelector('.c-author').value.trim();
                    const content = card.querySelector('.c-content').value.trim();
                    if (!content) return;
                    const posts = loadPosts();
                    const p = posts.find(x => String(x.id) === String(id));
                    if (!p) return;
                    p.comments = p.comments || [];
                    const payload = {
                        id,
                        author,
                        content,
                        images: []
                    };
                    await apiPost(`${API_BASE}/comment`, payload);
                    p.comments.push({
                        author,
                        content,
                        ts: Date.now()
                    });
                    savePosts(posts);
                    renderPosts(posts);
                });
            });
        }
        // æ–°å¢ï¼šè§†å›¾åº”ç”¨ä¸å¢å¼ºæ¸²æŸ“
        function getHotScore(p) {
            const likes = p.likes || 0;
            const comments = (p.comments || []).length;
            const reactions = p.reactions ? Object.values(p.reactions).reduce((a, b) => a + b, 0) : 0;
            return likes * 2 + comments + reactions;
        }

        function applyView(list) {
            let arr = list.slice();
            if (keyword) {
                const kw = keyword.toLowerCase();
                arr = arr.filter(p => String(p.author || '').toLowerCase().includes(kw) || String(p.content || '').toLowerCase().includes(kw));
            }
            if (activeTags && activeTags.length) {
                arr = arr.filter(p => activeTags.some(t => (p.tags || []).includes(t)));
            } else if (activeTag) {
                arr = arr.filter(p => (p.tags || []).includes(activeTag));
            }
            if (pinnedOnly) arr = arr.filter(p => p.pinned);
            if (onlyImages) arr = arr.filter(p => (p.images || []).length > 0);
            if (onlyLinks) arr = arr.filter(p => /https?:\/\/\S+/.test(p.content || ''));
            if (onlyMine && myName) arr = arr.filter(p => (p.author || '') === myName);
            arr.sort((a, b) => {
                if ((b.pinned ? 1 : 0) !== (a.pinned ? 1 : 0)) return (b.pinned ? 1 : 0) - (a.pinned ? 1 : 0);
                if (sortMode === 'hot') return getHotScore(b) - getHotScore(a);
                return b.ts - a.ts;
            });
            return arr;
        }
        let commentImagesTemp = {};

        function renderPosts2(list) {
            const box = document.getElementById('post-list');
            if (!box) return;
            if (!list.length) {
                box.innerHTML = '<div class="muted">ç›®å‰è¿˜æ²¡æœ‰å¸–å­ï¼Œå¿«æ¥å‘å¸ƒç¬¬ä¸€æ¡å§ï¼</div>';
                return;
            }
            const html = applyView(list).map(p => {
                        const time = new Date(p.ts).toLocaleString();
                        const tagsHtml = (p.tags || []).map(t => `<span class="tag small">${escapeHtml(t)}</span>`).join('');
                        const badgesHtml = getBadges(p.author, list).map(b => `<span class="badge">${escapeHtml(b)}</span>`).join('');
                        const cardClass = p.pinned ? 'post-card pinned' : 'post-card';
                        const commentsHtml = (p.comments || []).map(c => {
                            const ct = new Date(c.ts).toLocaleString();
                            const cImagesHtml = (c.images || []).map(src => `<img src="${src}" class="post-img" alt="è¯„è®ºå›¾ç‰‡">`).join('');
                            return `<div class="post-card" style="margin-top:6px;">
                    <div style="font-size:12px; color:#666;">${ct} Â· ${escapeHtml(c.author || 'åŒ¿å')}</div>
                    <div class="markdown-body">${renderMarkdown(c.content || '')}</div>
                    ${cImagesHtml}
                </div>`;
                        }).join('');
                        const react = p.reactions || {};
                        const reactionBar = `
                <div class="reaction-bar">
                    ${['ğŸ‘','â¤ï¸','ğŸ¯','ğŸ¤”'].map(em => {
                        const count = react[em]||0;
                        return `<button class="reaction-btn" data-em="${em}">${em} <span class="cnt">${count}</span></button>`;
                    }).join('')}
                </div>`;
            const imagesHtml = (p.images || []).map(src => `<img src="${src}" class="post-img" alt="é™„ä»¶å›¾ç‰‡">`).join('');
            return `<div class="${cardClass}" data-id="${p.id}">
                <div class="post-header">
                    <div class="meta">${time} Â· ${escapeHtml(p.author || 'åŒ¿å')} ${badgesHtml} ${p.pinned ? '<span class="badge badge-pin">ç½®é¡¶</span>' : ''}</div>
                    <div class="tags">${tagsHtml}</div>
                </div>
                <div style="margin-top:4px;" class="markdown-body">${renderMarkdown(p.content || '')}</div>
                ${imagesHtml}
                <div class="post-actions" style="margin-top:6px;">
                    <button class="btn btn-secondary like-btn">ğŸ‘ ç‚¹èµ</button>
                    <span class="like-count">${p.likes || 0} èµ</span>
                    ${isAdmin ? `<button class="btn btn-secondary pin-btn" title="ç½®é¡¶">${p.pinned ? 'ğŸ“Œ å–æ¶ˆç½®é¡¶' : 'ğŸ“Œ ç½®é¡¶'}</button>` : ''}
                    ${isAdmin ? `<button class="btn btn-secondary del-btn" title="åˆ é™¤">ğŸ—‘ï¸ åˆ é™¤</button>` : ''}
                </div>
                ${reactionBar}
                <details style="margin-top:8px;">
                    <summary>å‘è¡¨è¯„è®º</summary>
                    <div style="margin-top:6px;">
                        <input class="c-author" type="text" placeholder="æ˜µç§°" style="width: 40%"> 
                        <input class="c-content" type="text" placeholder="è¯„è®ºå†…å®¹" style="width: 58%"> 
                        <button class="btn btn-secondary c-submit">å‘å¸ƒè¯„è®º</button>
                        <div class="c-image-preview" style="margin-top:6px; display:flex; gap:6px; flex-wrap:wrap;"></div>
                        <div class="muted" style="font-size:12px; margin-top:4px;">æ”¯æŒç²˜è´´å›¾ç‰‡ï¼ˆâ‰¤300KBï¼‰</div>
                    </div>
                    <div class="comments">${commentsHtml}</div>
                </details>
            </div>`;
        }).join('');
        box.innerHTML = html;
        box.querySelectorAll('.like-btn').forEach(btn => {
            btn.addEventListener('click', async () => {
                const card = btn.closest('.post-card');
                const id = card && card.dataset && card.dataset.id;
                const posts = loadPosts();
                const p = posts.find(x => String(x.id) === String(id));
                if (p) {
                    await apiPost(`${API_BASE}/like`, { id });
                    p.likes = (p.likes || 0) + 1; savePosts(posts); renderPosts2(posts); renderSidebar(posts);
                }
            });
        });
        box.querySelectorAll('.c-submit').forEach(btn => {
            btn.addEventListener('click', async () => {
                const card = btn.closest('.post-card');
                const id = card && card.dataset && card.dataset.id;
                const author = card.querySelector('.c-author').value.trim();
                const content = card.querySelector('.c-content').value.trim();
                if (!content) return;
                const posts = loadPosts();
                const p = posts.find(x => String(x.id) === String(id));
                if (!p) return;
                p.comments = p.comments || [];
                const imgs = (commentImagesTemp[id] || []).slice();
                await apiPost(`${API_BASE}/comment`, { id, author, content, images: imgs });
                p.comments.push({ author, content, ts: Date.now(), images: imgs });
                commentImagesTemp[id] = [];
                savePosts(posts);
                renderPosts2(posts); renderSidebar(posts);
            });
        });
        box.querySelectorAll('.c-content').forEach(inp => {
            inp.addEventListener('paste', (e) => {
                const card = inp.closest('.post-card');
                const id = card && card.dataset && card.dataset.id;
                const prev = card.querySelector('.c-image-preview');
                const items = (e.clipboardData && e.clipboardData.items) || [];
                for (const it of items) {
                    if (it.type && it.type.startsWith('image/')) {
                        const file = it.getAsFile();
                        if (!file) continue;
                        const max = 300 * 1024;
                        if (file.size > max) { alert('å›¾ç‰‡è¿‡å¤§ï¼Œéœ€â‰¤300KB'); continue; }
                        const reader = new FileReader();
                        reader.onload = () => {
                            const src = reader.result;
                            if (!commentImagesTemp[id]) commentImagesTemp[id] = [];
                            commentImagesTemp[id].push(src);
                            if (prev) {
                                const img = document.createElement('img');
                                img.src = src; img.className = 'post-img';
                                prev.appendChild(img);
                            }
                        };
                        reader.readAsDataURL(file);
                    }
                }
            });
        });
        box.querySelectorAll('.pin-btn').forEach(btn => {
            btn.addEventListener('click', async () => {
                if (!isAdmin) { alert('åªæœ‰ç®¡ç†å‘˜å¯ä»¥ç½®é¡¶å¸–å­'); return; }
                const card = btn.closest('.post-card');
                const id = card && card.dataset && card.dataset.id;
                const posts = loadPosts();
                const p = posts.find(x => String(x.id) === String(id));
                if (p) {
                    const next = !p.pinned;
                    const resp = await apiPost(`${API_BASE}/pin`, { id, pinned: next }, adminHeaders());
                    if (resp && resp.ok) {
                        p.pinned = next; savePosts(posts); renderPosts2(posts); renderSidebar(posts);
                    } else {
                        alert('ç½®é¡¶å¤±è´¥ï¼šè¯·ç¡®è®¤å·²ç™»å½•ç®¡ç†å‘˜');
                    }
                }
            });
        });
        box.querySelectorAll('.del-btn').forEach(btn => {
            btn.addEventListener('click', async () => {
                if (!isAdmin) { alert('åªæœ‰ç®¡ç†å‘˜å¯ä»¥åˆ é™¤å¸–å­'); return; }
                const card = btn.closest('.post-card');
                const id = card && card.dataset && card.dataset.id;
                let posts = loadPosts();
                if (confirm('ç¡®å®šåˆ é™¤è¯¥å¸–å­ï¼Ÿæ­¤æ“ä½œä¼šåŒæ­¥åç«¯ï¼Œå¯¹æ‰€æœ‰äººç”Ÿæ•ˆ')) {
                    const resp = await apiPost(`${API_BASE}/delete`, { id }, adminHeaders());
                    if (resp && resp.ok) {
                        posts = posts.filter(x => String(x.id) !== String(id));
                        savePosts(posts);
                        renderPosts2(posts);
                        renderSidebar(posts);
                    } else {
                        alert('åˆ é™¤å¤±è´¥ï¼šè¯·ç¡®è®¤å·²ç™»å½•ç®¡ç†å‘˜');
                    }
                }
            });
        });
        box.querySelectorAll('.reaction-btn').forEach(btn => {
            btn.addEventListener('click', async () => {
                const card = btn.closest('.post-card');
                const id = card && card.dataset && card.dataset.id;
                const em = btn.dataset.em;
                const posts = loadPosts();
                const p = posts.find(x => String(x.id) === String(id));
                if (!p) return;
                p.reactions = p.reactions || {};
                p.reactions[em] = (p.reactions[em]||0) + 1;
                // ç®€åŒ–ï¼šreaction ä¸å…¥åº“ï¼Œä»…æœ¬åœ°ç»Ÿè®¡ï¼›å¦‚éœ€å…±äº«å¯å¢åŠ åç«¯æ¥å£
                savePosts(posts);
                renderPosts2(posts); renderSidebar(posts);
            });
        });
    }
    function escapeHtml(str = '') {
        return String(str).replace(/[&<>"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[s]));
    }
    function renderMarkdown(md = '') {
        try {
            if (window.marked) {
                const html = window.marked.parse(String(md));
                if (window.DOMPurify) return window.DOMPurify.sanitize(html);
                return html;
            }
            return escapeHtml(md).replace(/\n/g,'<br>');
        } catch { return escapeHtml(String(md)); }
    }
    function filterByRange(list, range) {
        const now = new Date();
        if (range === 'today') {
            const base = new Date(now); base.setHours(0,0,0,0);
            return list.filter(p => { const d = new Date(p.ts||Date.now()); d.setHours(0,0,0,0); return d.getTime() === base.getTime(); });
        }
        if (range === 'week') {
            const cutoff = Date.now() - 7*24*60*60*1000;
            return list.filter(p => (p.ts||0) >= cutoff);
        }
        return list;
    }
    function dataURLToBlob(dataUrl) {
        try {
            const parts = dataUrl.split(',');
            const meta = parts[0].match(/:(.*?);/)[1];
            const bstr = atob(parts[1]);
            let n = bstr.length; const u8arr = new Uint8Array(n);
            while (n--) { u8arr[n] = bstr.charCodeAt(n); }
            return new Blob([u8arr], { type: meta });
        } catch { return new Blob([]); }
    }
    function extractImagesFromMarkdown(text = '') {
        const urls = [];
        try {
            const mdImg = /!\[[^\]]*\]\(([^\s)]+)(?:\s+"[^"]*")?\)/g;
            let m;
            while ((m = mdImg.exec(text)) !== null) { urls.push(m[1]); }
            const htmlImg = /<img[^>]+src=["']([^"'>]+)["'][^>]*>/gi;
            while ((m = htmlImg.exec(text)) !== null) { urls.push(m[1]); }
        } catch {}
        return urls;
    }
    function filenameFromUrl(url, idx, mime) {
        try {
            const u = new URL(url);
            const name = u.pathname.split('/').pop() || `comment_img_${idx}`;
            if (name.includes('.')) return name;
        } catch {}
        const ext = (mime||'').includes('jpeg') ? 'jpg' : (mime||'').split('/')[1] || 'png';
        return `comment_img_${idx}.${ext}`;
    }
    function updateImageStatus(state) {
        const countEl = document.getElementById('img-count');
        const sizeEl = document.getElementById('img-size');
        const barEl = document.getElementById('image-progress-bar');
        const hintEl = document.getElementById('img-hint');
        const inputEl = document.getElementById('image');
        const count = state.sizes.length;
        const total = state.sizes.reduce((a,b)=>a+b,0);
        const pct = Math.min(100, Math.round(total / MAX_TOTAL_SIZE * 100));
        if (countEl) countEl.textContent = String(count);
        if (sizeEl) sizeEl.textContent = `${Math.round(total/1024)}KB`;
        if (barEl) barEl.style.width = `${pct}%`;
        let warn = '';
        if (count > MAX_IMAGE_COUNT) warn += `è¶…è¿‡æ•°é‡é™åˆ¶ï¼ˆæœ€å¤š${MAX_IMAGE_COUNT}å¼ ï¼‰ï¼›`;
        if (total > MAX_TOTAL_SIZE) warn += `è¶…è¿‡æ€»å¤§å°é™åˆ¶ï¼ˆâ‰¤2MBï¼‰ï¼›`;
        if (hintEl) hintEl.textContent = warn ? `è­¦å‘Šï¼š${warn}` : 'æç¤ºï¼šå•å¼ â‰¤300KBï¼Œæœ€å¤š6å¼ ï¼Œæ€»è®¡â‰¤2MB';
        if (inputEl) inputEl.disabled = count >= MAX_IMAGE_COUNT || total >= MAX_TOTAL_SIZE;
    }
    function computeTagStats(list) {
        const map = {};
        list.forEach(p => (p.tags||[]).forEach(t => { map[t] = (map[t]||0) + 1; }));
        const arr = Object.entries(map).map(([tag,count]) => ({tag,count}));
        arr.sort((a,b) => b.count - a.count);
        return arr;
    }
    function getBadges(author, list) {
        const mine = list.filter(p => (p.author||'') === (author||''));
        const postsCount = mine.length;
        const likes = mine.reduce((a,b)=>a+(b.likes||0),0);
        const comments = mine.reduce((a,b)=>a+((b.comments||[]).length),0);
        const imagesCount = mine.reduce((a,b)=>a+((b.images||[]).length),0);
        const pinnedCount = mine.filter(p=>p.pinned).length;
        const maxHot = mine.reduce((m,p)=> Math.max(m, getHotScore(p)), 0);
        const badges = [];
        if (postsCount >= 3) badges.push('æ–°é”ä½œè€…');
        if (postsCount >= 10) badges.push('èµ„æ·±ä½œè€…');
        if (likes >= 10) badges.push('äººæ°”é«˜æ¶¨');
        if (comments >= 10) badges.push('äº’åŠ¨è¾¾äºº');
        if (imagesCount >= 3) badges.push('å›¾åƒè´¡çŒ®è€…');
        if (pinnedCount >= 2) badges.push('ç½®é¡¶ä¹‹ä¸»');
        if (maxHot >= 8) badges.push('çƒ­åº¦ä¹‹æ˜Ÿ');
        return badges;
    }
    function generateSummary(list) {
        const total = list.length;
        const topTags = computeTagStats(list).slice(0,3).map(s=>s.tag).join('ã€');
        const topLikePost = list.slice().sort((a,b)=> (b.likes||0)-(a.likes||0))[0];
        const pinnedCount = list.filter(p=>p.pinned).length;
        const snippet = topLikePost ? String(topLikePost.content||'').slice(0,80) : '';
        return `æœ¬é¡µå…±${total}æ¡å¸–å­ï¼Œçƒ­é—¨æ ‡ç­¾ï¼š${topTags||'æ— '}ï¼›ç½®é¡¶${pinnedCount}æ¡ã€‚æœ€é«˜èµå†…å®¹æ‘˜å½•ï¼š${snippet}`;
    }
    function renderSidebar(list) {
        const hotBox = document.getElementById('hot-tags');
        const todayBox = document.getElementById('today-topic');
        const sumBox = document.getElementById('summary-text');
        if (hotBox) {
            const stats = computeTagStats(filterByRange(list, hotRange));
            hotBox.innerHTML = stats.length ? stats.slice(0,6).map(s => `<button class="tag small hot-tag" data-tag="${escapeHtml(s.tag)}">${escapeHtml(s.tag)} <span class="cnt">${s.count}</span></button>`).join(' ') : '<div class="muted">æš‚æ— æ ‡ç­¾æ•°æ®</div>';
            hotBox.querySelectorAll('.hot-tag').forEach(btn => {
                btn.addEventListener('click', () => {
                    const t = btn.dataset.tag;
                    if (!activeTags.includes(t)) activeTags.push(t);
                    localStorage.setItem(PREF_TAGS_MULTI_KEY, JSON.stringify(activeTags));
                    document.querySelectorAll('.tag-filter .tag').forEach(el => { if (el.dataset.tag === t) el.classList.add('active'); });
                    renderPosts2(loadPosts());
                });
            });
        }
        if (todayBox) {
            const today = new Date(); today.setHours(0,0,0,0);
            const listToday = list.filter(p => { const d=new Date(p.ts||Date.now()); d.setHours(0,0,0,0); return d.getTime()===today.getTime(); });
            const stats = computeTagStats(listToday);
            todayBox.innerHTML = stats.length ? `<div>ä»Šæ—¥æœ€çƒ­ï¼š<span class="tag small">${escapeHtml(stats[0].tag)}</span>ï¼ˆ${stats[0].count}æ¡ï¼‰</div>` : '<div class="muted">ä»Šæ—¥å°šæ— ä¸»é¢˜</div>';
        }
        if (sumBox) {
            sumBox.textContent = generateSummary(list);
        }
    }
    function speakText(text) {
        if (!('speechSynthesis' in window) || !text) return;
        try { window.speechSynthesis.cancel(); } catch {}
        const u = new SpeechSynthesisUtterance(String(text).replace(/\s+/g,' '));
        const rate = parseFloat(localStorage.getItem('ai_voice_rate') || '1.0');
        const pitch = parseFloat(localStorage.getItem('ai_voice_pitch') || '1.0');
        const saved = localStorage.getItem('ai_voice_pref') || '';
        u.rate = !Number.isNaN(rate)?rate:1.0;
        u.pitch = !Number.isNaN(pitch)?pitch:1.0;
        try {
            const voices = window.speechSynthesis.getVoices() || [];
            const voice = voices.find(v=> v.name === saved) || voices.find(v=>/zh|cmn/i.test(v.lang||'')) || null;
            if (voice) { u.voice = voice; u.lang = voice.lang || 'zh-CN'; }
        } catch {}
        window.speechSynthesis.speak(u);
    }
    document.addEventListener('DOMContentLoaded', () => {
        const author = document.getElementById('author');
        const content = document.getElementById('content');
        const publish = document.getElementById('publish');
        const clearAll = document.getElementById('clearAll');
        const imageInput = document.getElementById('image');
        const imagePreview = document.getElementById('image-preview');
        const tagChips = document.querySelectorAll('.tag-select .tag');
        const toolbarSearch = document.getElementById('forum-search');
        const toolbarSort = document.getElementById('forum-sort');
        const toolbarTags = document.querySelectorAll('.tag-filter .tag');
        const pinnedOnlyCheck = document.getElementById('only-pinned');
        const onlyImagesCheck = document.getElementById('only-images');
        const onlyLinksCheck = document.getElementById('only-links');
        const myNameInput = document.getElementById('my-name');
        const onlyMineCheck = document.getElementById('only-mine');
        const exportBtn = document.getElementById('export-json');
        const genSummaryBtn = document.getElementById('gen-summary');
        const speakSummaryBtn = document.getElementById('speak-summary');
        const summaryBox = document.getElementById('summary-text');
        const hotRangeSel = document.getElementById('hot-range');
        const summaryOnlyCheck = document.getElementById('summary-only-filter');
        const insertGuideBtn = document.getElementById('insert-guide');
        const clearGuideBtn = document.getElementById('clear-guide');
        const exportZipBtn = document.getElementById('export-zip');
        const profileBtn = document.getElementById('profile-btn');
        const mdPreview = document.getElementById('md-preview');
        const mdToggle = document.getElementById('md-toggle');
        if (author && currentUser) author.value = currentUser;
        if (toolbarSearch) toolbarSearch.value = keyword;
        if (toolbarSort) toolbarSort.value = sortMode;
        toolbarTags.forEach(t => { if (activeTags.includes(t.dataset.tag)) t.classList.add('active'); else t.classList.remove('active'); });
        // é¦–æ¬¡åŠ è½½ï¼šä»åç«¯åŒæ­¥é›†ä¸­å­˜å‚¨
        syncFromServer().then(list => { renderPosts2(list); renderSidebar(list); }).catch(() => { const posts = loadPosts(); renderPosts2(posts); renderSidebar(posts); });
        let selectedTags = [];
        let selectedImages = [];
        let selectedImageSizes = [];
        function addImage(file) {
            const max = 300 * 1024; // 300KB
            if (!file) return;
            if (file.size > max) { alert('å›¾ç‰‡è¿‡å¤§ï¼Œéœ€â‰¤300KB'); return; }
            const reader = new FileReader();
            reader.onload = () => {
                const src = reader.result;
                selectedImages.push(src);
                selectedImageSizes.push(file.size || 0);
                if (imagePreview) {
                    const img = document.createElement('img');
                    img.src = src; img.className = 'post-img';
                    imagePreview.appendChild(img);
                }
                updateImageStatus({ sizes: selectedImageSizes });
            };
            reader.readAsDataURL(file);
        }
        if (imageInput) imageInput.addEventListener('change', () => { const f = imageInput.files && imageInput.files[0]; if (f) addImage(f); });
        if (content) {
            content.addEventListener('paste', (e) => {
                const items = (e.clipboardData && e.clipboardData.items) || [];
                for (const it of items) {
                    if (it.type && it.type.startsWith('image/')) {
                        const file = it.getAsFile(); if (file) addImage(file);
                    }
                }
            });
        }
        tagChips.forEach(ch => {
            ch.addEventListener('click', () => {
                const tag = ch.dataset.tag;
                if (selectedTags.includes(tag)) {
                    selectedTags = selectedTags.filter(x => x !== tag);
                    ch.classList.remove('active');
                } else {
                    selectedTags.push(tag);
                    ch.classList.add('active');
                }
            });
        });
        publish.addEventListener('click', async () => {
            const a = author.value.trim();
            const c = content.value.trim();
            if (!c) return;
            const posts = loadPosts();
            const draft = { id: Date.now(), author: a || currentUser || 'åŒ¿å', content: c, ts: Date.now(), likes: 0, comments: [], tags: selectedTags.slice(), reactions: {}, pinned: false, images: selectedImages.slice() };
            posts.push(draft);
            // åç«¯æŒä¹…åŒ–ï¼ˆå¤±è´¥ä¸é˜»å¡æœ¬åœ°æ¸²æŸ“ï¼‰
            apiPost(`${API_BASE}/post`, draft);
            savePosts(posts);
            author.value = '';
            content.value = '';
            selectedTags = [];
            tagChips.forEach(ch => ch.classList.remove('active'));
            selectedImages = [];
            selectedImageSizes = [];
            if (imagePreview) imagePreview.innerHTML = '';
            updateImageStatus({ sizes: selectedImageSizes });
            renderPosts2(posts);
            renderSidebar(posts);
        });
        clearAll.addEventListener('click', () => { savePosts([]); renderPosts2([]); });
        if (toolbarSearch) toolbarSearch.addEventListener('input', () => {
            keyword = toolbarSearch.value.trim();
            localStorage.setItem(PREF_SEARCH_KEY, keyword);
            const posts = loadPosts(); renderPosts2(posts); renderSidebar(posts);
        });
        if (toolbarSort) toolbarSort.addEventListener('change', () => {
            sortMode = toolbarSort.value;
            localStorage.setItem(PREF_SORT_KEY, sortMode);
            const posts = loadPosts(); renderPosts2(posts); renderSidebar(posts);
        });
        toolbarTags.forEach(t => {
            t.addEventListener('click', () => {
                const tg = t.dataset.tag;
                if (!tg) {
                    activeTags = [];
                    activeTag = '';
                    localStorage.setItem(PREF_TAGS_MULTI_KEY, JSON.stringify(activeTags));
                    localStorage.setItem(PREF_TAG_KEY, activeTag);
                    toolbarTags.forEach(x => x.classList.remove('active'));
                } else {
                    const i = activeTags.indexOf(tg);
                    if (i >= 0) { activeTags.splice(i,1); t.classList.remove('active'); }
                    else { activeTags.push(tg); t.classList.add('active'); }
                    localStorage.setItem(PREF_TAGS_MULTI_KEY, JSON.stringify(activeTags));
                }
                const posts = loadPosts(); renderPosts2(posts); renderSidebar(posts);
            });
        });
        if (pinnedOnlyCheck) { pinnedOnlyCheck.checked = pinnedOnly; pinnedOnlyCheck.addEventListener('change', () => { pinnedOnly = pinnedOnlyCheck.checked; localStorage.setItem(PINNED_ONLY_KEY, pinnedOnly?'true':'false'); const posts = loadPosts(); renderPosts2(posts); renderSidebar(posts); }); }
        if (onlyImagesCheck) { onlyImagesCheck.checked = onlyImages; onlyImagesCheck.addEventListener('change', () => { onlyImages = onlyImagesCheck.checked; localStorage.setItem(ONLY_IMAGES_KEY, onlyImages?'true':'false'); const posts = loadPosts(); renderPosts2(posts); renderSidebar(posts); }); }
        if (onlyLinksCheck) { onlyLinksCheck.checked = onlyLinks; onlyLinksCheck.addEventListener('change', () => { onlyLinks = onlyLinksCheck.checked; localStorage.setItem(ONLY_LINKS_KEY, onlyLinks?'true':'false'); const posts = loadPosts(); renderPosts2(posts); renderSidebar(posts); }); }
        if (myNameInput) { myNameInput.value = myName; myNameInput.addEventListener('input', () => { myName = myNameInput.value.trim(); localStorage.setItem(MY_NAME_KEY, myName); const posts = loadPosts(); renderPosts2(posts); renderSidebar(posts); }); }
        if (onlyMineCheck) { onlyMineCheck.checked = onlyMine; onlyMineCheck.addEventListener('change', () => { onlyMine = onlyMineCheck.checked; localStorage.setItem(ONLY_MINE_KEY, onlyMine?'true':'false'); const posts = loadPosts(); renderPosts2(posts); renderSidebar(posts); }); }
        if (exportBtn) exportBtn.addEventListener('click', () => {
            const data = JSON.stringify(loadPosts(), null, 2);
            const blob = new Blob([data], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = 'forum_posts.json'; a.click();
            URL.revokeObjectURL(url);
        });
        if (genSummaryBtn) genSummaryBtn.addEventListener('click', () => {
            const posts = loadPosts();
            const source = (summaryOnlyCheck && summaryOnlyCheck.checked) ? applyView(posts) : posts;
            summaryBox.textContent = generateSummary(source);
        });
        if (speakSummaryBtn) speakSummaryBtn.addEventListener('click', () => { const t = (summaryBox && summaryBox.textContent) || ''; speakText(t); });
        if (insertGuideBtn) insertGuideBtn.addEventListener('click', () => {
            const posts = loadPosts();
            const source = (summaryOnlyCheck && summaryOnlyCheck.checked) ? applyView(posts) : posts;
            const text = generateSummary(source);
            const guide = document.getElementById('page-guide');
            if (guide) guide.innerHTML = `<div class="post-card guide-card"><div class="meta">æœ¬é¡µå¯¼è¯»</div><div class="markdown-body">${renderMarkdown(text)}</div></div>`;
        });
        if (clearGuideBtn) clearGuideBtn.addEventListener('click', () => { const guide = document.getElementById('page-guide'); if (guide) guide.innerHTML = ''; });
        if (hotRangeSel) {
            hotRangeSel.value = hotRange;
            hotRangeSel.addEventListener('change', () => { hotRange = hotRangeSel.value; localStorage.setItem(HOT_TAG_RANGE_KEY, hotRange); renderSidebar(loadPosts()); });
        }
        if (exportZipBtn) exportZipBtn.addEventListener('click', async () => {
            const posts = loadPosts();
            const list = applyView(posts);
            const zip = new JSZip();
            let idx = 1;
            const externalFailed = [];
            const seen = new Set();
            for (const p of list) {
                for (const c of (p.comments||[])) {
                    const urls = extractImagesFromMarkdown(c.content||'');
                    const attachments = (c.images || []);
                    for (const src of urls.concat(attachments)) {
                        if (seen.has(src)) continue; seen.add(src);
                        try {
                            if (src.startsWith('data:image/')) {
                                const blob = dataURLToBlob(src);
                                zip.file(filenameFromUrl(src, idx, blob.type||'image/png'), blob);
                                idx++;
                            } else {
                                const resp = await fetch(src);
                                if (!resp.ok) throw new Error(`fetch failed: ${resp.status}`);
                                const blob = await resp.blob();
                                const name = filenameFromUrl(src, idx, blob.type);
                                zip.file(name, blob);
                                idx++;
                            }
                        } catch (e) {
                            externalFailed.push(src);
                        }
                    }
                }
            }
            if (externalFailed.length) {
                const info = `ä»¥ä¸‹å›¾ç‰‡å› è·¨åŸŸæˆ–ç½‘ç»œåŸå› æœªæ‰“åŒ…ï¼Œè¯·æ‰‹åŠ¨ä¸‹è½½ï¼š\n` + externalFailed.join('\n');
                zip.file('external_images.txt', info);
            }
            const contentZip = await zip.generateAsync({ type: 'blob' });
            const url = URL.createObjectURL(contentZip);
            const a = document.createElement('a');
            a.href = url; a.download = 'forum_comment_images.zip'; a.click();
            URL.revokeObjectURL(url);
        });
        // Markdown å·¥å…·æ è¡Œä¸º
        function wrapSelection(before, after) {
            if (!content) return;
            const start = content.selectionStart || 0;
            const end = content.selectionEnd || 0;
            const val = content.value;
            const sel = val.slice(start, end);
            const out = val.slice(0, start) + before + sel + after + val.slice(end);
            content.value = out;
            content.focus();
            content.selectionStart = start + before.length;
            content.selectionEnd = end + before.length;
            if (mdPreview && mdPreview.style.display !== 'none') mdPreview.innerHTML = renderMarkdown(content.value);
        }
        document.querySelectorAll('.md-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const act = btn.dataset.act;
                if (act === 'bold') wrapSelection('**', '**');
                else if (act === 'italic') wrapSelection('*', '*');
                else if (act === 'code') wrapSelection('`', '`');
                else if (act === 'quote') wrapSelection('\n> ', '');
                else if (act === 'link') wrapSelection('[', '](https://)');
                else if (act === 'h1') wrapSelection('# ', '');
                else if (act === 'h2') wrapSelection('## ', '');
                else if (act === 'ul') wrapSelection('\n- ', '');
            });
        });
        if (mdToggle) {
            mdToggle.addEventListener('click', () => {
                if (!mdPreview) return;
                const visible = mdPreview.style.display !== 'none';
                mdPreview.style.display = visible ? 'none' : '';
                if (!visible) mdPreview.innerHTML = renderMarkdown(content.value || '');
            });
        }
        if (content && mdPreview) content.addEventListener('input', () => { if (mdPreview.style.display !== 'none') mdPreview.innerHTML = renderMarkdown(content.value || ''); });

        // ä¸ªäººä¸»é¡µå¼¹çª—
        function openProfile(name) {
            const posts = loadPosts();
            const mine = posts.filter(p => (p.author||'') === (name||''));
            const body = document.getElementById('profile-body');
            const modal = document.getElementById('profile-modal');
            const badges = getBadges(name, posts);
            const postsCount = mine.length;
            const likes = mine.reduce((a,b)=>a+(b.likes||0),0);
            const comments = mine.reduce((a,b)=>a+((b.comments||[]).length),0);
            const imagesCount = mine.reduce((a,b)=>a+((b.images||[]).length),0);
            const pinnedCount = mine.filter(p=>p.pinned).length;
            const topPost = mine.slice().sort((a,b)=> (b.likes||0)-(a.likes||0))[0];
            const snippet = topPost ? String(topPost.content||'').slice(0,120) : '';
            if (body) {
                body.innerHTML = `
                    <div class="meta">æ˜µç§°ï¼š${escapeHtml(name||'æœªå¡«å†™')}</div>
                    <div style="margin-top:6px;">å¾½ç« ï¼š${badges.map(b=>`<span class='badge'>${escapeHtml(b)}</span>`).join(' ') || '<span class="muted">æš‚æ— </span>'}</div>
                    <ul style="margin-top:10px;">
                        <li>å‘å¸–ï¼š${postsCount} æ¡</li>
                        <li>æ€»èµï¼š${likes} æ¬¡</li>
                        <li>æ€»è¯„ï¼š${comments} æ¡</li>
                        <li>å›¾ç‰‡ï¼š${imagesCount} å¼ </li>
                        <li>ç½®é¡¶ï¼š${pinnedCount} æ¡</li>
                    </ul>
                    <div style="margin-top:8px;" class="markdown-body">${renderMarkdown(snippet ? `æœ€é«˜èµå†…å®¹æ‘˜å½•ï¼š\n\n> ${snippet}` : 'æš‚æ— ä»£è¡¨ä½œ')}</div>
                `;
            }
            if (modal) modal.style.display = 'block';
        }
        function closeProfile() { const modal = document.getElementById('profile-modal'); if (modal) modal.style.display = 'none'; }
        const profileClose = document.getElementById('profile-close');
        if (profileClose) profileClose.addEventListener('click', () => closeProfile());
        if (profileBtn) profileBtn.addEventListener('click', () => { const name = myName || ((document.getElementById('my-name') && document.getElementById('my-name').value) || ''); openProfile(name); });
        if (speakSummaryBtn) speakSummaryBtn.addEventListener('click', () => { const txt = (summaryBox && summaryBox.textContent) || generateSummary(loadPosts()); speakText(txt); });
    });
    </script>
</body>

</html>