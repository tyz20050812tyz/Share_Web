<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸ªäººä¸­å¿ƒ - ä»¥å²ä¸ºé‰´ï¼Œå‡èšåŠ›é‡</title>
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <header class="site-header">
        <div class="wrap">
            <h1>ğŸ›ï¸ ä¸ªäººä¸­å¿ƒ</h1>
            <nav class="main-nav">
                <a href="index.html">ä¸»é¡µ</a>
                <a href="ai.html">æ™ºèƒ½é—®ç­”</a>
                <a href="knowledge.html">çŸ¥è¯†åˆ†äº«</a>
                <a href="culture.html">æ–‡åŒ–ä¼ æ’­</a>
                <a href="discuss.html">è®¨è®ºåŒº</a>
                <a href="game.html">è¶£å‘³å°„å‡»</a>
                <a href="models.html">3Då±•é¦†</a>
                <a href="challenge.html" class="nav-challenge">ğŸ¯ äº’åŠ¨å­¦ä¹ </a>
                <a href="history_today.html" class="nav-history">ğŸ“… å†å²ä¸Šçš„ä»Šå¤©</a>
                <a href="contest.html" class="nav-contest">ğŸ† åˆ›ä½œç«èµ›</a>
                <a href="contest_works.html">ğŸ“š ä½œå“å±•ç¤º</a>
                <a href="profile.html" class="nav-profile active">ğŸ‘¤ ä¸ªäººä¸­å¿ƒ</a>
            </nav>
        </div>
    </header>

    <div class="user-bar" id="userBar"></div>

    <div class="wrap" style="max-width:1200px;">
        <!-- ä¸ªäººä¿¡æ¯å¡ç‰‡ -->
        <div class="card" style="margin-top:20px;text-align:center;padding:40px;background:linear-gradient(135deg,#fff5f5,#fde7e7);position:relative;overflow:hidden;">
            <div style="position:absolute;top:-20px;right:-20px;font-size:150px;opacity:0.1;">ğŸ¯</div>
            <div style="width:140px;height:140px;border-radius:50%;background:linear-gradient(135deg,#c62828,#e53935);margin:0 auto 20px;font-size:70px;color:white;display:flex;align-items:center;justify-content:center;box-shadow:0 8px 32px rgba(198,40,40,0.3);border:5px solid white;">
                <span id="user-avatar">ğŸ‘¤</span>
            </div>
            <div style="font-size:36px;font-weight:bold;margin-bottom:10px;" id="user-name">æ¸¸å®¢</div>
            <div style="font-size:18px;color:#666;background:rgba(198,40,40,0.1);padding:5px 20px;border-radius:20px;display:inline-block;" id="user-role">æ™®é€šç”¨æˆ·</div>
        </div>

        <!-- æ•°æ®æ€»è§ˆ -->
        <div class="stats-grid" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:20px;margin:30px 0;">
            <div class="stat-card card" style="border-left:4px solid #4caf50;">
                <div style="font-size:48px;margin-bottom:10px;">ğŸ’¬</div>
                <div style="font-size:14px;color:#666;margin-bottom:8px;">è®¨è®ºå‘å¸–</div>
                <div style="font-size:32px;font-weight:bold;color:#4caf50;" id="discuss-posts">0</div>
            </div>
            <div class="stat-card card" style="border-left:4px solid #673ab7;">
                <div style="font-size:48px;margin-bottom:10px;">âœï¸</div>
                <div style="font-size:14px;color:#666;margin-bottom:8px;">ç«èµ›ä½œå“</div>
                <div style="font-size:32px;font-weight:bold;color:#673ab7;" id="contest-works">0</div>
            </div>
            <div class="stat-card card" style="border-left:4px solid #ff9800;">
                <div style="font-size:48px;margin-bottom:10px;">ğŸ®</div>
                <div style="font-size:14px;color:#666;margin-bottom:8px;">æ¸¸æˆå±€æ•°</div>
                <div style="font-size:32px;font-weight:bold;color:#ff9800;" id="games-played">0</div>
            </div>
            <div class="stat-card card" style="border-left:4px solid #f44336;">
                <div style="font-size:48px;margin-bottom:10px;">ğŸ¯</div>
                <div style="font-size:14px;color:#666;margin-bottom:8px;">ç­”é¢˜å¾—åˆ†</div>
                <div style="font-size:32px;font-weight:bold;color:#f44336;" id="quiz-score">0</div>
            </div>
        </div>

        <!-- æ ‡ç­¾é¡µ -->
        <div class="card" style="padding:20px;">
            <div style="display:flex;gap:10px;border-bottom:2px solid #eee;margin-bottom:30px;flex-wrap:wrap;">
                <button class="tab-btn active" data-tab="game" style="padding:12px 24px;background:transparent;border:none;border-bottom:3px solid #c62828;cursor:pointer;font-size:16px;font-weight:600;color:#c62828;">
                    ğŸ® æ¸¸æˆæˆ˜ç»©
                </button>
                <button class="tab-btn" data-tab="discuss" style="padding:12px 24px;background:transparent;border:none;border-bottom:3px solid transparent;cursor:pointer;font-size:16px;font-weight:600;color:#666;">
                    ğŸ’¬ è®¨è®ºåŠ¨æ€
                </button>
                <button class="tab-btn" data-tab="contest" style="padding:12px 24px;background:transparent;border:none;border-bottom:3px solid transparent;cursor:pointer;font-size:16px;font-weight:600;color:#666;">
                    âœï¸ åˆ›ä½œè®°å½•
                </button>
                <button class="tab-btn" data-tab="challenge" style="padding:12px 24px;background:transparent;border:none;border-bottom:3px solid transparent;cursor:pointer;font-size:16px;font-weight:600;color:#666;">
                    ğŸ“ ç­”é¢˜æ’è¡Œ
                </button>
                <button class="tab-btn" data-tab="guestbook" style="padding:12px 24px;background:transparent;border:none;border-bottom:3px solid transparent;cursor:pointer;font-size:16px;font-weight:600;color:#666;">
                    ğŸ“ æˆ‘çš„ç•™è¨€
                </button>
            </div>

            <!-- æ¸¸æˆæˆ˜ç»©æ ‡ç­¾ -->
            <div class="tab-content active" id="tab-game">
                <div id="game-stats"></div>
            </div>

            <!-- è®¨è®ºåŠ¨æ€æ ‡ç­¾ -->
            <div class="tab-content" id="tab-discuss" style="display:none;">
                <div id="discuss-activity"></div>
            </div>

            <!-- åˆ›ä½œè®°å½•æ ‡ç­¾ -->
            <div class="tab-content" id="tab-contest" style="display:none;">
                <div id="contest-activity"></div>
            </div>

            <!-- ç­”é¢˜æ’è¡Œæ ‡ç­¾ -->
            <div class="tab-content" id="tab-challenge" style="display:none;">
                <div id="challenge-stats"></div>
            </div>

            <!-- æˆ‘çš„ç•™è¨€æ ‡ç­¾ -->
            <div class="tab-content" id="tab-guestbook" style="display:none;">
                <!-- ç•™è¨€è¡¨å• -->
                <div style="background:#f9f9f9;padding:20px;border-radius:12px;margin-bottom:30px;">
                    <h3 style="margin:0 0 20px 0;color:#c62828;font-size:20px;">âœ’ï¸ å‘è¡¨ç•™è¨€</h3>
                    <form id="messageForm">
                        <div style="margin-bottom:15px;">
                            <label style="display:block;font-weight:600;margin-bottom:8px;color:#333;">ç•™è¨€æ ‡é¢˜ *</label>
                            <input type="text" id="messageTitle" placeholder="è¯·è¾“å…¥ç•™è¨€æ ‡é¢˜ï¼ˆæœ€å¤š50å­—ï¼‰" maxlength="50" required style="width:100%;padding:12px;border:2px solid #e0e0e0;border-radius:8px;font-size:15px;box-sizing:border-box;">
                        </div>
                        <div style="margin-bottom:15px;">
                            <label style="display:block;font-weight:600;margin-bottom:8px;color:#333;">ç•™è¨€å†…å®¹ *</label>
                            <textarea id="messageContent" placeholder="è¯·è¾“å…¥ç•™è¨€å†…å®¹ï¼ˆæœ€å¤š500å­—ï¼‰" maxlength="500" required style="width:100%;min-height:120px;padding:12px;border:2px solid #e0e0e0;border-radius:8px;font-size:15px;resize:vertical;box-sizing:border-box;font-family:inherit;"></textarea>
                            <div style="text-align:right;font-size:12px;color:#999;margin-top:5px;">
                                <span id="charCount">0</span> / 500
                            </div>
                        </div>
                        <button type="submit" id="submitBtn" style="background:linear-gradient(135deg,#c62828,#e53935);color:white;border:none;padding:12px 30px;border-radius:8px;font-size:16px;font-weight:bold;cursor:pointer;">
                            ğŸ“® æäº¤ç•™è¨€
                        </button>
                    </form>
                </div>

                <!-- ç•™è¨€åˆ—è¡¨ -->
                <div id="userMessageSection">
                    <div style="padding:20px;background:rgba(198,40,40,0.05);border-radius:12px;text-align:center;">
                        <p style="margin:0;color:#666;font-size:15px;line-height:1.8;">ğŸ’¡ æ„Ÿè°¢æ‚¨çš„ç•™è¨€ï¼æ‚¨çš„å®è´µæ„è§å°†æäº¤ç»™ç®¡ç†å‘˜å®¡é˜…ã€‚</p>
                    </div>
                </div>

                <!-- ç®¡ç†å‘˜ç•™è¨€ç®¡ç†ï¼ˆä»…ç®¡ç†å‘˜å¯è§ï¼‰ -->
                <div id="adminGuestbookSection" style="display:none;">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;padding:20px 0;border-top:2px solid #eee;">
                        <h3 style="margin:0;color:#333;font-size:20px;">ğŸ›¡ï¸ ç”¨æˆ·ç•™è¨€ç®¡ç†</h3>
                        <div style="background:#ff9800;color:white;padding:6px 16px;border-radius:20px;font-size:14px;font-weight:600;">
                            å…± <span id="allMessageCount">0</span> æ¡ç•™è¨€
                        </div>
                    </div>
                    <div id="allMessagesList">
                        <div style="text-align:center;padding:40px;color:#999;">åŠ è½½ä¸­...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <footer class="site-footer">
        <div class="wrap">Â© 2025 ä»¥å²ä¸ºé‰´ï¼Œå‡èšåŠ›é‡</div>
    </footer>

    <script src="main.js"></script>
    <script>
        // æ ‡ç­¾é¡µåˆ‡æ¢
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const tab = btn.dataset.tab;
                document.querySelectorAll('.tab-btn').forEach(b => {
                    b.style.borderBottom = '3px solid transparent';
                    b.style.color = '#666';
                });
                btn.style.borderBottom = '3px solid #c62828';
                btn.style.color = '#c62828';

                document.querySelectorAll('.tab-content').forEach(c => c.style.display = 'none');
                document.getElementById('tab-' + tab).style.display = 'block';
            });
        });

        // åŠ è½½ç”¨æˆ·ä¿¡æ¯
        function loadUserProfile() {
            const userName = localStorage.getItem('login_user') || 'æ¸¸å®¢';
            const userRole = localStorage.getItem('login_role') || 'user';
            document.getElementById('user-name').textContent = userName;
            document.getElementById('user-role').textContent = userRole === 'admin' ? 'ç®¡ç†å‘˜' : 'æ™®é€šç”¨æˆ·';
            document.getElementById('user-avatar').textContent = userName.charAt(0).toUpperCase();
        }

        // åŠ è½½è®¨è®ºåŒºæ•°æ®
        function loadDiscussData() {
            const posts = JSON.parse(localStorage.getItem('forum_posts_v1') || '[]');
            const userName = localStorage.getItem('login_user') || 'æ¸¸å®¢';
            const myPosts = posts.filter(p => p.author === userName);
            document.getElementById('discuss-posts').textContent = myPosts.length;

            const container = document.getElementById('discuss-activity');
            if (myPosts.length === 0) {
                container.innerHTML = '<div style="text-align:center;padding:40px;color:#999;">æš‚æ— è®¨è®ºè®°å½•</div>';
            } else {
                container.innerHTML = myPosts.slice(0, 5).map(p => `
                    <div style="background:rgba(198,40,40,0.05);padding:15px;border-radius:8px;margin-bottom:10px;">
                        <div style="font-weight:600;margin-bottom:5px;">${p.content.substring(0, 50)}...</div>
                        <div style="font-size:12px;color:#999;">${new Date(p.timestamp).toLocaleString()}</div>
                    </div>
                `).join('');
            }
        }

        // åŠ è½½ç«èµ›æ•°æ®
        async function loadContestData() {
            const userName = localStorage.getItem('login_user') || 'æ¸¸å®¢';

            try {
                // ä»æœåŠ¡å™¨åŠ è½½ç”¨æˆ·çš„æŠ•ç¨¿ä½œå“
                const response = await fetch(`/api/submissions?userId=${encodeURIComponent(userName)}`);
                const data = await response.json();

                if (data.ok && data.submissions) {
                    const myWorks = data.submissions.filter(s => s.status === 'published');
                    document.getElementById('contest-works').textContent = myWorks.length;

                    const container = document.getElementById('contest-activity');
                    if (myWorks.length === 0) {
                        container.innerHTML = '<div style="text-align:center;padding:40px;color:#999;">æš‚æ— ç«èµ›ä½œå“</div>';
                    } else {
                        container.innerHTML = myWorks.slice(0, 5).map(w => {
                            const date = new Date(w.createdAt).toLocaleString('zh-CN', {
                                year: 'numeric',
                                month: '2-digit',
                                day: '2-digit',
                                hour: '2-digit',
                                minute: '2-digit'
                            });
                            return `
                                <div style="background:rgba(198,40,40,0.05);padding:15px;border-radius:8px;margin-bottom:10px;cursor:pointer;transition:all 0.3s;" 
                                     onmouseover="this.style.background='rgba(198,40,40,0.1)'" 
                                     onmouseout="this.style.background='rgba(198,40,40,0.05)'"
                                     onclick="location.href='contest_works.html?id=${w.id}'">
                                    <div style="display:flex;justify-content:space-between;align-items:start;">
                                        <div style="flex:1;">
                                            <div style="font-weight:600;margin-bottom:5px;font-size:16px;">${w.title}</div>
                                            <div style="font-size:12px;color:#999;margin-bottom:8px;">${date}</div>
                                            <div style="display:flex;gap:15px;font-size:13px;color:#666;">
                                                <span>ğŸ‘ ${w.votes || 0} æŠ•ç¥¨</span>
                                                <span>ğŸ‘ï¸ ${w.views || 0} æµè§ˆ</span>
                                                ${w.featured ? '<span style="color:#ffd700;">â­ ç²¾é€‰</span>' : ''}
                                            </div>
                                        </div>
                                        <div style="background:rgba(198,40,40,0.1);padding:4px 12px;border-radius:12px;font-size:12px;color:#c62828;">
                                            ${w.category || 'æ–‡ç« '}
                                        </div>
                                    </div>
                                </div>
                            `;
                        }).join('');
                    }
                } else {
                    document.getElementById('contest-works').textContent = '0';
                    document.getElementById('contest-activity').innerHTML = '<div style="text-align:center;padding:40px;color:#999;">æš‚æ— ç«èµ›ä½œå“</div>';
                }
            } catch (error) {
                console.error('åŠ è½½ç«èµ›æ•°æ®å¤±è´¥:', error);
                document.getElementById('contest-works').textContent = '0';
                document.getElementById('contest-activity').innerHTML = '<div style="text-align:center;padding:40px;color:#f44336;">åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•</div>';
            }
        }

        // åŠ è½½æ¸¸æˆæ•°æ®
        function loadGameData() {
            const stats = JSON.parse(localStorage.getItem('gameStats') || '{"gamesPlayed":0,"totalScore":0}');
            document.getElementById('games-played').textContent = stats.gamesPlayed || 0;

            const container = document.getElementById('game-stats');
            container.innerHTML = `
                <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px;">
                    <div style="background:rgba(198,40,40,0.05);padding:20px;border-radius:8px;border-left:4px solid #c62828;">
                        <div style="font-size:14px;color:#666;">æ€»å±€æ•°</div>
                        <div style="font-size:28px;font-weight:bold;color:#c62828;">${stats.gamesPlayed || 0}</div>
                    </div>
                    <div style="background:rgba(198,40,40,0.05);padding:20px;border-radius:8px;border-left:4px solid #c62828;">
                        <div style="font-size:14px;color:#666;">ç´¯è®¡å¾—åˆ†</div>
                        <div style="font-size:28px;font-weight:bold;color:#c62828;">${stats.totalScore || 0}</div>
                    </div>
                </div>
            `;
        }

        // åŠ è½½ç­”é¢˜æ•°æ®
        function loadChallengeData() {
            const userName = localStorage.getItem('login_user') || 'æ¸¸å®¢';
            const rankings = JSON.parse(localStorage.getItem('quiz_rankings') || '[]');
            const userRankings = rankings.filter(r => r.name === userName).sort((a, b) => b.score - a.score);

            const bestScore = userRankings.length > 0 ? userRankings[0].score : 0;
            document.getElementById('quiz-score').textContent = bestScore;

            const container = document.getElementById('challenge-stats');
            if (userRankings.length === 0) {
                container.innerHTML = '<div style="text-align:center;padding:40px;color:#999;">æš‚æ— ç­”é¢˜è®°å½•</div>';
            } else {
                container.innerHTML = userRankings.slice(0, 5).map((r, i) => `
                    <div style="background:rgba(198,40,40,0.05);padding:15px;border-radius:8px;margin-bottom:10px;display:flex;justify-content:space-between;">
                        <div>
                            <div style="font-weight:600;">ç¬¬ ${i + 1} æ¬¡ç­”é¢˜</div>
                            <div style="font-size:12px;color:#999;">ç­”å¯¹ ${r.correct}/${r.total} é¢˜</div>
                        </div>
                        <div style="font-size:24px;font-weight:bold;color:#c62828;">${r.score}åˆ†</div>
                    </div>
                `).join('');
            }
        }

        // ===== ç•™è¨€ç®±åŠŸèƒ½ =====
        let allMessages = [];
        let isSubmitting = false;

        // å­—ç¬¦è®¡æ•°
        function updateCharCount() {
            const content = document.getElementById('messageContent');
            const counter = document.getElementById('charCount');
            if (content && counter) {
                counter.textContent = content.value.length;
                counter.style.color = content.value.length > 450 ? '#f44336' : '#999';
            }
        }

        // åˆå§‹åŒ–ç•™è¨€ç®±æ˜¾ç¤ºï¼ˆæ ¹æ®è§’è‰²ï¼‰
        async function initGuestbook() {
            const userRole = localStorage.getItem('login_role');

            if (userRole === 'admin') {
                // ç®¡ç†å‘˜ï¼šæ˜¾ç¤ºç®¡ç†åŒºåŸŸï¼Œéšè—æ™®é€šç”¨æˆ·æç¤º
                document.getElementById('userMessageSection').style.display = 'none';
                document.getElementById('adminGuestbookSection').style.display = 'block';
                await loadAllMessages();
            } else {
                // æ™®é€šç”¨æˆ·ï¼šæ˜¾ç¤ºæç¤ºï¼Œéšè—ç®¡ç†åŒºåŸŸ
                document.getElementById('userMessageSection').style.display = 'block';
                document.getElementById('adminGuestbookSection').style.display = 'none';
            }
        }

        // åŠ è½½æ‰€æœ‰ç•™è¨€ï¼ˆä»…ç®¡ç†å‘˜ï¼‰
        async function loadAllMessages() {
            try {
                const response = await fetch('/api/guestbook/list');
                const data = await response.json();

                if (data.ok) {
                    allMessages = data.messages || [];
                    renderAllMessages();
                }
            } catch (error) {
                console.error('åŠ è½½ç•™è¨€å¤±è´¥:', error);
                document.getElementById('allMessagesList').innerHTML = '<div style="text-align:center;padding:40px;color:#f44336;">åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•</div>';
            }
        }

        // æ¸²æŸ“æ‰€æœ‰ç•™è¨€ï¼ˆä»…ç®¡ç†å‘˜ï¼‰
        function renderAllMessages() {
            const container = document.getElementById('allMessagesList');
            const counter = document.getElementById('allMessageCount');

            counter.textContent = allMessages.length;

            if (allMessages.length === 0) {
                container.innerHTML = '<div style="text-align:center;padding:40px;color:#999;">ğŸ’­ æš‚æ— ç”¨æˆ·ç•™è¨€</div>';
                return;
            }

            container.innerHTML = allMessages.map(msg => {
                const isAdmin = msg.role === 'admin';
                return `
                    <div style="background:#fff;border:2px solid #f0f0f0;border-radius:12px;padding:20px;margin-bottom:15px;transition:all 0.3s;position:relative;"
                         onmouseover="this.style.borderColor='#c62828';this.style.boxShadow='0 4px 12px rgba(198,40,40,0.1)'"
                         onmouseout="this.style.borderColor='#f0f0f0';this.style.boxShadow='none'">
                        <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:15px;">
                            <div style="flex:1;">
                                <div style="font-size:18px;font-weight:bold;color:#333;margin-bottom:8px;">${escapeHtml(msg.title)}</div>
                                <div style="display:flex;gap:15px;font-size:13px;color:#666;flex-wrap:wrap;">
                                    <span>ğŸ‘¤ <span style="background:${isAdmin ? 'linear-gradient(135deg,#ff9800,#fb8c00)' : 'linear-gradient(135deg,#c62828,#e53935)'};color:white;padding:2px 8px;border-radius:4px;font-size:12px;font-weight:bold;">${escapeHtml(msg.author)}</span></span>
                                    <span>ğŸ•’ ${formatTime(msg.createdAt)}</span>
                                </div>
                            </div>
                            <button onclick="deleteAdminMessage('${msg.id}')" 
                                    style="background:#f44336;color:white;border:none;padding:6px 12px;border-radius:6px;font-size:13px;cursor:pointer;transition:all 0.3s;"
                                    onmouseover="this.style.background='#d32f2f'"
                                    onmouseout="this.style.background='#f44336'">
                                ğŸ—‘ï¸ åˆ é™¤
                            </button>
                        </div>
                        <div style="color:#555;line-height:1.8;white-space:pre-wrap;word-wrap:break-word;background:rgba(0,0,0,0.02);padding:15px;border-radius:8px;">${escapeHtml(msg.content)}</div>
                    </div>
                `;
            }).join('');
        }

        // æäº¤ç•™è¨€
        async function submitMessage(e) {
            e.preventDefault();

            if (isSubmitting) return;

            const title = document.getElementById('messageTitle').value.trim();
            const content = document.getElementById('messageContent').value.trim();
            const userName = localStorage.getItem('login_user');
            const userRole = localStorage.getItem('login_role');

            if (!title || !content) {
                alert('è¯·å¡«å†™å®Œæ•´çš„ç•™è¨€ä¿¡æ¯ï¼');
                return;
            }

            isSubmitting = true;
            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;
            submitBtn.textContent = 'æäº¤ä¸­...';

            try {
                const response = await fetch('/api/guestbook/submit', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        title,
                        content,
                        author: userName,
                        role: userRole
                    })
                });

                const data = await response.json();

                if (data.ok) {
                    alert('âœ… ç•™è¨€å‘è¡¨æˆåŠŸï¼æ„Ÿè°¢æ‚¨çš„å®è´µæ„è§ï¼');
                    document.getElementById('messageTitle').value = '';
                    document.getElementById('messageContent').value = '';
                    updateCharCount();

                    // å¦‚æœæ˜¯ç®¡ç†å‘˜ï¼Œé‡æ–°åŠ è½½ç•™è¨€åˆ—è¡¨
                    if (userRole === 'admin') {
                        await loadAllMessages();
                    }
                } else {
                    alert('âŒ æäº¤å¤±è´¥ï¼š' + (data.error || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (error) {
                console.error('æäº¤ç•™è¨€å¤±è´¥:', error);
                alert('âŒ æäº¤å¤±è´¥ï¼šç½‘ç»œé”™è¯¯æˆ–æœåŠ¡å™¨å¼‚å¸¸');
            } finally {
                isSubmitting = false;
                submitBtn.disabled = false;
                submitBtn.textContent = 'ğŸ“® æäº¤ç•™è¨€';
            }
        }

        // ç®¡ç†å‘˜åˆ é™¤ç•™è¨€
        window.deleteAdminMessage = async function(messageId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡ç•™è¨€å—ï¼Ÿ')) return;

            const userName = localStorage.getItem('login_user');
            const userRole = localStorage.getItem('login_role');

            if (userRole !== 'admin') {
                alert('æ‚¨æ²¡æœ‰æƒé™åˆ é™¤ç•™è¨€ï¼');
                return;
            }

            try {
                const response = await fetch(`/api/guestbook/delete/${messageId}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        user: userName,
                        role: userRole
                    })
                });

                const data = await response.json();

                if (data.ok) {
                    alert('âœ… åˆ é™¤æˆåŠŸï¼');
                    await loadAllMessages();
                } else {
                    alert('âŒ åˆ é™¤å¤±è´¥ï¼š' + (data.error || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (error) {
                console.error('åˆ é™¤ç•™è¨€å¤±è´¥:', error);
                alert('âŒ åˆ é™¤å¤±è´¥ï¼šç½‘ç»œé”™è¯¯æˆ–æœåŠ¡å™¨å¼‚å¸¸');
            }
        };

        // HTMLè½¬ä¹‰
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // æ—¶é—´æ ¼å¼åŒ–
        function formatTime(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();
            const diff = now - date;

            if (diff < 60000) return 'åˆšåˆš';
            if (diff < 3600000) return `${Math.floor(diff / 60000)}åˆ†é’Ÿå‰`;
            if (diff < 86400000) return `${Math.floor(diff / 3600000)}å°æ—¶å‰`;
            if (diff < 604800000) return `${Math.floor(diff / 86400000)}å¤©å‰`;

            return date.toLocaleString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // é¡µé¢åŠ è½½
        window.addEventListener('load', () => {
            loadUserProfile();
            loadDiscussData();
            loadContestData();
            loadGameData();
            loadChallengeData();

            // ç»‘å®šç•™è¨€è¡¨å•äº‹ä»¶
            const messageForm = document.getElementById('messageForm');
            const messageContent = document.getElementById('messageContent');

            if (messageForm) {
                messageForm.addEventListener('submit', submitMessage);
            }

            if (messageContent) {
                messageContent.addEventListener('input', updateCharCount);
            }

            // åˆå§‹åŒ–ç•™è¨€ç®±ï¼ˆæ ¹æ®ç”¨æˆ·è§’è‰²ï¼‰
            initGuestbook();
        });
    </script>
</body>

</html>