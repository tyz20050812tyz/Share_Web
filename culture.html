<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ–‡åŒ–ä¼ æ’­ â€” ä»¥å²ä¸ºé‰´ï¼Œå‡èšåŠ›é‡</title>
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <header class="site-header">
        <div class="wrap">
            <h1>æ–‡åŒ–ä¼ æ’­ï¼ˆä¸»é¢˜æ­Œæ›²ä¸å†å²è®°å¿†ï¼‰</h1>
            <nav class="main-nav">
                <a href="index.html">ä¸»é¡µ</a>
                <a href="ai.html">æ™ºèƒ½é—®ç­”</a>
                <a href="knowledge.html">çŸ¥è¯†åˆ†äº«</a>
                <a href="culture.html" class="active">æ–‡åŒ–ä¼ æ’­</a>
                <a href="discuss.html">è®¨è®ºåŒº</a>
                <a href="game.html">è¶£å‘³å°„å‡»</a>
                <a href="models.html">3Då±•é¦†</a>
                <a href="challenge.html" class="nav-challenge">ğŸ¯ äº’åŠ¨å­¦ä¹ </a>
                <a href="history_today.html" class="nav-history">ğŸ“… å†å²ä¸Šçš„ä»Šå¤©</a>
                <a href="contest.html" class="nav-contest">ğŸ† åˆ›ä½œç«èµ›</a>
                <a href="contest_works.html">ğŸ“š ä½œå“å±•ç¤º</a>
                <a href="profile.html" class="nav-profile">ğŸ‘¤ ä¸ªäººä¸­å¿ƒ</a>
            </nav>
        </div>
    </header>

    <div class="user-bar" id="userBar"></div>

    <main class="wrap">
        <section class="card">
            <div class="section-title">ä¸»é¢˜æ›²ç²¾é€‰ï¼ˆæœ¬åœ°æ’­æ”¾ï¼‰</div>
            <div class="subsection-desc">ä»¥ä¸‹ä¸ºâ€œæ­Œæ›²â€ç›®å½•ä¸­çš„å…­é¦–æ›²ç›®ï¼ŒæŒ‰åºå·æ’åˆ—ï¼Œå¯åœ¨çº¿æ’­æ”¾æˆ–ä¸‹è½½ã€‚</div>
            <div class="grid-3" style="grid-template-columns: 1fr;">
                <div class="post-card">
                    <h3>1 å®¶å›­ä¸å†</h3>
                    <audio controls src="/songs/1å®¶å›­ä¸å†.mp3"></audio>
                    <a class="download-link" href="/songs/1å®¶å›­ä¸å†.mp3" download>ä¸‹è½½ã€Š1å®¶å›­ä¸å†.mp3ã€‹</a>
                </div>
                <div class="post-card">
                    <h3>2 é»„æ²³åœ¨å‘å–Š</h3>
                    <audio controls src="/songs/2é»„æ²³åœ¨å‘å–Š.mp3"></audio>
                    <a class="download-link" href="/songs/2é»„æ²³åœ¨å‘å–Š.mp3" download>ä¸‹è½½ã€Š2é»„æ²³åœ¨å‘å–Š.mp3ã€‹</a>
                </div>
                <div class="post-card">
                    <h3>3 æ˜Ÿæ˜Ÿä¹‹ç«</h3>
                    <audio controls src="/songs/3æ˜Ÿæ˜Ÿä¹‹ç«.mp3"></audio>
                    <a class="download-link" href="/songs/3æ˜Ÿæ˜Ÿä¹‹ç«.mp3" download>ä¸‹è½½ã€Š3æ˜Ÿæ˜Ÿä¹‹ç«.mp3ã€‹</a>
                </div>
                <div class="post-card">
                    <h3>4 é•¿åŸä¸‹çš„èª“è¨€</h3>
                    <audio controls src="/songs/4é•¿åŸä¸‹çš„èª“è¨€.mp3"></audio>
                    <a class="download-link" href="/songs/4é•¿åŸä¸‹çš„èª“è¨€.mp3" download>ä¸‹è½½ã€Š4é•¿åŸä¸‹çš„èª“è¨€.mp3ã€‹</a>
                </div>
                <div class="post-card">
                    <h3>5 å‘ç€å…‰è¾‰çš„å½¼å²¸</h3>
                    <audio controls src="/songs/5å‘ç€å…‰è¾‰çš„å½¼å²¸.mp3"></audio>
                    <a class="download-link" href="/songs/5å‘ç€å…‰è¾‰çš„å½¼å²¸.mp3" download>ä¸‹è½½ã€Š5å‘ç€å…‰è¾‰çš„å½¼å²¸.mp3ã€‹</a>
                </div>
                <div class="post-card">
                    <h3>6 ç™¾å¹´å›å“</h3>
                    <audio controls src="/songs/6ç™¾å¹´å›å“.mp3"></audio>
                    <a class="download-link" href="/songs/6ç™¾å¹´å›å“.mp3" download>ä¸‹è½½ã€Š6ç™¾å¹´å›å“.mp3ã€‹</a>
                </div>
            </div>
        </section>

        <div class="scenarios-actions">
            <p class="tip">æç¤ºï¼šç”Ÿæˆè¿‡ç¨‹åœ¨æœ¬åœ°å®Œæˆï¼Œæ— éœ€è”ç½‘ã€‚ä½ ä¹Ÿå¯ä»¥å°†åˆæˆæ—‹å¾‹æˆ–æœ¬åœ°æ›²ç›®ç”¨äºä¸»é¢˜å®£ä¼ ç´ æã€‚</p>
            <a href="index.html" class="btn btn-secondary">â† è¿”å›ä¸»é¡µ</a>
        </div>
    </main>

    <footer class="site-footer">
        <div class="wrap">Â© 2025 ä»¥å²ä¸ºé‰´ï¼Œå‡èšåŠ›é‡</div>
    </footer>

    <script>
        function encodeWAV(audioBuffer) {
            const numChannels = audioBuffer.numberOfChannels;
            const sampleRate = audioBuffer.sampleRate;
            const samples = audioBuffer.length;
            const bytesPerSample = 2; // 16-bit PCM
            const blockAlign = numChannels * bytesPerSample;
            const dataSize = samples * blockAlign;
            const buffer = new ArrayBuffer(44 + dataSize);
            const view = new DataView(buffer);
            let offset = 0;

            function writeString(s) {
                for (let i = 0; i < s.length; i++) view.setUint8(offset++, s.charCodeAt(i));
            }

            function writeUint32(v) {
                view.setUint32(offset, v, true);
                offset += 4;
            }

            function writeUint16(v) {
                view.setUint16(offset, v, true);
                offset += 2;
            }

            // RIFF header
            writeString('RIFF');
            writeUint32(36 + dataSize);
            writeString('WAVE');
            // fmt chunk
            writeString('fmt ');
            writeUint32(16); // PCM
            writeUint16(1); // format
            writeUint16(numChannels);
            writeUint32(sampleRate);
            writeUint32(sampleRate * blockAlign);
            writeUint16(blockAlign);
            writeUint16(8 * bytesPerSample);
            // data chunk
            writeString('data');
            writeUint32(dataSize);

            const interleaved = new Float32Array(samples * numChannels);
            for (let ch = 0; ch < numChannels; ch++) {
                const channelData = audioBuffer.getChannelData(ch);
                for (let i = 0; i < samples; i++) {
                    interleaved[i * numChannels + ch] = channelData[i];
                }
            }

            // float32 -> int16
            let idx = 0;
            for (let i = 0; i < interleaved.length; i++) {
                let s = Math.max(-1, Math.min(1, interleaved[i]));
                view.setInt16(44 + idx, s < 0 ? s * 0x8000 : s * 0x7FFF, true);
                idx += 2;
            }
            return new Blob([view], {
                type: 'audio/wav'
            });
        }

        async function generateSong({
            mood = 'maj',
            bpm = 96,
            sec = 20
        } = {}) {
            const sampleRate = 44100;
            const length = Math.floor(sec * sampleRate);
            const ctx = new OfflineAudioContext(2, length, sampleRate);

            const notesMaj = [261.63, 293.66, 329.63, 349.23, 392.00, 440.00, 523.25]; // Cå¤§è°ƒ
            const notesMin = [261.63, 293.66, 311.13, 349.23, 392.00, 440.00, 493.88]; // Cå°è°ƒ
            const scale = mood === 'min' ? notesMin : notesMaj;

            const oscLead = ctx.createOscillator();
            oscLead.type = 'sawtooth';
            const gainLead = ctx.createGain();
            gainLead.gain.setValueAtTime(0.0, 0);
            oscLead.connect(gainLead).connect(ctx.destination);

            const oscBass = ctx.createOscillator();
            oscBass.type = 'square';
            const gainBass = ctx.createGain();
            gainBass.gain.setValueAtTime(0.0, 0);
            oscBass.connect(gainBass).connect(ctx.destination);

            const beatLen = 60 / bpm; // æ¯æ‹ç§’æ•°
            const start = 0;
            let t = start;
            oscLead.start(start);
            oscBass.start(start);

            // ç®€å•ä¹å¥ï¼šä¸»æ—‹å¾‹ä¸ä½éŸ³åˆ†æ‹æ¨è¿›ï¼ŒåŠ å…¥åŒ…ç»œ
            while (t < sec) {
                const nIdx = Math.floor(Math.random() * scale.length);
                const freq = scale[nIdx];
                const bassFreq = scale[0] / 2; // ä½éŸ³å›ºå®šæ ¹éŸ³

                // ä¸»æ—‹å¾‹ï¼šä¸¤æ‹ä¸€ä¸ªéŸ³ï¼Œåšè½»å¾®æ»‘éŸ³
                oscLead.frequency.linearRampToValueAtTime(freq, t + 0.01);
                gainLead.gain.cancelScheduledValues(t);
                gainLead.gain.setValueAtTime(0.0, t);
                gainLead.gain.linearRampToValueAtTime(0.6, t + 0.04);
                gainLead.gain.exponentialRampToValueAtTime(0.15, t + beatLen * 1.8);

                // ä½éŸ³ï¼šæ¯æ‹è§¦å‘ï¼Œç¨³å›ºèŠ‚å¥
                oscBass.frequency.setValueAtTime(bassFreq, t);
                gainBass.gain.cancelScheduledValues(t);
                gainBass.gain.setValueAtTime(0.0, t);
                gainBass.gain.linearRampToValueAtTime(0.4, t + 0.02);
                gainBass.gain.exponentialRampToValueAtTime(0.08, t + beatLen * 0.9);

                t += beatLen * 2;
            }

            oscLead.stop(sec);
            oscBass.stop(sec);
            const rendered = await ctx.startRendering();
            return rendered;
        }

        document.addEventListener('DOMContentLoaded', () => {
            const moodEl = document.getElementById('mood');
            const bpmEl = document.getElementById('bpm');
            const secEl = document.getElementById('sec');
            const genBtn = document.getElementById('gen');
            const player = document.getElementById('player');
            const download = document.getElementById('download');
            const tip = document.getElementById('gen-tip');

            genBtn.addEventListener('click', async() => {
                const mood = moodEl.value;
                const bpm = Math.max(60, Math.min(140, Number(bpmEl.value) || 96));
                const sec = Math.max(5, Math.min(60, Number(secEl.value) || 20));
                tip.textContent = 'æ­£åœ¨ç”Ÿæˆï¼Œè¯·ç¨å€™â€¦';
                genBtn.disabled = true;
                try {
                    const buf = await generateSong({
                        mood,
                        bpm,
                        sec
                    });
                    const wav = encodeWAV(buf);
                    const url = URL.createObjectURL(wav);
                    player.src = url;
                    player.play().catch(() => {});
                    download.href = url;
                    download.style.display = 'inline';
                    tip.textContent = `å·²ç”Ÿæˆï¼š${mood === 'min' ? 'å°è°ƒ' : 'å¤§è°ƒ'}ï¼Œ${bpm} BPMï¼Œ${sec}s`;
                } catch (e) {
                    tip.textContent = 'ç”Ÿæˆå¤±è´¥ï¼š' + e.message;
                } finally {
                    genBtn.disabled = false;
                }
            });
        });
    </script>
</body>

</html>